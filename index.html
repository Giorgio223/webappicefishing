<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IceFishing</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.0/dist/tonconnect-ui.min.js"></script>

  <style>
    :root{
      --leaf1:#e6e8ec;
      --leaf2:#3d647f;
      --red:#e11d48;
      --orange:#fb923c;
      --blue:#0b2a8f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 25% 15%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 70% 35%, rgba(255,255,255,.15), rgba(255,255,255,0) 65%),
        url("bg.png") center/cover no-repeat fixed;
    }

    /* snow */
    .snow{pointer-events:none; position:fixed; inset:0; z-index:2; overflow:hidden;}
    .snow span{
      position:absolute; top:-10vh;
      width:6px; height:6px;
      background:rgba(255,255,255,.85);
      border-radius:50%;
      opacity:.85;
      animation: fall linear infinite;
    }
    @keyframes fall{ from{transform:translateY(-10vh)} to{transform:translateY(110vh)} }

    /* confetti */
    .confettiLayer{position:fixed; inset:0; pointer-events:none; z-index:50; overflow:hidden;}
    .confettiPiece{
      position:absolute; top:-12vh;
      width:10px; height:16px;
      border-radius:2px;
      opacity:.95;
      transform: translate3d(0,0,0) rotate(0deg);
      animation-name: confettiFall;
      animation-timing-function: cubic-bezier(.14,.84,.25,1);
      animation-fill-mode: forwards;
    }
    @keyframes confettiFall{
      0%   { transform: translate3d(0,-15vh,0) rotate(0deg); }
      100% { transform: translate3d(var(--dx, 0px), 115vh, 0) rotate(var(--rot, 720deg)); }
    }

    /* HUD */
    .leftHUD{
      position:fixed; left:12px; top:14px;
      display:flex; align-items:center; gap:10px;
      z-index:6; user-select:none; pointer-events:none;
    }
    .cube{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(180,225,255,.75));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      position:relative;
    }
    .cube:after{
      content:""; position:absolute;
      inset:7px 8px 12px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.65); opacity:.9;
    }
    .hudText{
      font-weight:950; letter-spacing:.6px; color:#0b1220; line-height:1;
      min-width:120px; text-transform:uppercase;
      text-shadow: 0 6px 18px rgba(0,0,0,.12);
    }

    /* top right */
    .hudRight{
      position:fixed; right:12px; top:14px; z-index:6;
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      font-weight:950;
      color:#0b1220;
      min-width:120px;
      justify-content:center;
    }
    .pill img{ width:18px; height:18px; border-radius:6px; }
    .pill small{ font-weight:900; opacity:.75; margin-left:4px; }

    .tonBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer; user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none; color:#0b1220;
      font-weight:950;
    }
    .tonBtn img{ width:22px; height:22px; border-radius:6px; }
    .tonBtn:active{ transform: translateY(1px); }

    /* wheel */
    .wheelWrap{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width:min(430px, 92vw);
      height:min(430px, 92vw);
      z-index:3;
      filter: drop-shadow(0 26px 44px rgba(0,0,0,.30));
    }
    canvas{ width:100%; height:100%; border-radius:50%; display:block; }

    /* pointer: red rod */
    .pointer{
      position:absolute;
      left:50%;
      top:-10px;
      transform: translateX(-50%);
      width:90px;
      height:56px;
      pointer-events:none;
      z-index:10;
      filter: drop-shadow(0 12px 12px rgba(0,0,0,.22));
    }
    .pointerRod{
      position:absolute;
      left:50%;
      top:10px;
      width:7px;
      height:44px;
      transform: translateX(-50%) rotate(0deg) skewX(0deg) scaleY(1);
      transform-origin: 50% 0%;
      border-radius:999px;
      background: linear-gradient(180deg, #ff4d4d, #c81d25);
      border:1px solid rgba(0,0,0,.18);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16);
    }

    /* bottom UI */
    .bottomUI{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(430px, 92vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:4;
    }
    .historyBar{
      width:100%;
      display:flex; gap:6px;
      justify-content:center; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .chip{
      width:16px; height:16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      flex:0 0 auto;
      position:relative;
    }
    .chip::after{
      content:"";
      position:absolute; inset:4px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      opacity:.55;
    }
    .chip.fish::before, .chip.leaf::before{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      content:"";
    }
    .chip.fish::before{ content:"üêü"; }
    .chip.leaf::before{ content:"üçÉ"; }

    .bonusPanel{ width:100%; display:flex; flex-direction:column; gap:10px; }
    .bonusTop, .bonusBottom{ display:flex; gap:8px; justify-content:space-between; }

    .btn{
      position:relative;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      border-radius:16px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ height:42px; flex:1 1 0; font-size:13px; }
    .btn.big{
      height:58px; flex:1 1 0; font-size:12px;
      text-transform:uppercase; letter-spacing:.4px;
      text-align:center; padding:0 10px;
    }
    .btnIcon{
      width:26px; height:26px;
      border-radius:999px;
      background: rgba(255,255,255,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      border:1px solid rgba(0,0,0,.10);
    }
    .c-leaf1{ background: color-mix(in srgb, var(--leaf1) 86%, white 14%); color:#0b1220; }
    .c-leaf2{ background: color-mix(in srgb, var(--leaf2) 86%, white 14%); color:#fff; }
    .c-blue { background: color-mix(in srgb, var(--blue) 74%, white 26%); color:#fff; }
    .c-orange{ background: color-mix(in srgb, var(--orange) 74%, white 26%); color:#1b1b1b; }
    .c-red { background: color-mix(in srgb, var(--red) 74%, white 26%); color:#fff; }

    .placedBet{
      position:absolute;
      right:8px;
      top:8px;
      min-width:34px;
      height:28px;
      padding:0 8px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:950;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      background: rgba(255,255,255,.75);
      color:#0b1220;
    }

    .betRow{ display:flex; justify-content:center; align-items:center; gap:10px; }
    .undoBtn{
      width:44px; height:44px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:not-allowed; user-select:none;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; color:#0b1220;
      -webkit-tap-highlight-color: transparent;
      opacity:.55;
    }

    .betSelect{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      font-weight:950;
      color:#0b1220;
      -webkit-tap-highlight-color: transparent;
    }
    .betHint{ font-size:11px; font-weight:900; opacity:.75; }
    .chev{ opacity:.75; font-weight:950; }
    .betMenu{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:56px;
      min-width:240px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.82);
      box-shadow: 0 18px 34px rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
      display:none;
      z-index:10;
    }
    .betMenu.open{ display:block; }
    .betOptions{ display:flex; gap:8px; justify-content:center; }
    .betChip{
      width:46px; height:46px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
    }
    .c01{ background:#7c3aed; color:#fff; }
    .c02{ background:#22c55e; color:#0b1220; }
    .c05{ background:#f59e0b; color:#1b1b1b; }
    .c10{ background:#ef4444; color:#fff; }

    /* modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:20;
    }
    .modalOverlay.open{ display:flex; }
    .sheet{
      width:min(520px, 96vw);
      border-radius:22px 22px 0 0;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 -18px 40px rgba(0,0,0,.28);
      padding:14px;
      padding-bottom:18px;
    }
    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:6px 6px 12px 6px;
    }
    .sheetTitle{
      font-weight:950; color:#0b1220; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sheetTitle img{ width:22px; height:22px; border-radius:6px; }
    .closeBtn{
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:950;
    }
    .sheetBtns{ display:flex; flex-direction:column; gap:10px; padding:0 6px; }
    .sheetAction{
      height:54px; border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(245,250,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      cursor:pointer; user-select:none;
      font-weight:950; color:#0b1220;
    }
    .depositInput{
      width:100%; height:52px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      padding:0 14px;
      font-size:18px; font-weight:900;
      outline:none;
    }
    .row2{ display:flex; gap:10px; margin-top:12px; }
    .row2 .sheetAction{ flex:1 1 0; justify-content:center; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>
  <div class="confettiLayer" id="confetti"></div>

  <div class="hudRight">
    <div class="pill" title="–ë–∞–ª–∞–Ω—Å">
      <img src="ton.png" alt="TON" />
      <span id="balanceValue">0</span><small>TON</small>
    </div>
    <a class="tonBtn" href="javascript:void(0)" id="tonConnectBtn">
      <img src="ton.png" alt="TON" />
      <span id="tonBtnText">TON connect</span>
    </a>
  </div>

  <div class="leftHUD">
    <div class="cube"></div>
    <div class="hudText">
      <span id="hudMain">0</span>
    </div>
  </div>

  <div class="wheelWrap">
    <canvas id="wheel" width="900" height="900"></canvas>
    <div class="pointer" aria-hidden="true"><div class="pointerRod" id="pointerRod"></div></div>
  </div>

  <div class="bottomUI">
    <div class="historyBar" id="historyBar"></div>

    <div class="bonusPanel">
      <div class="bonusTop">
        <div class="btn small c-leaf1 bettable" data-target="leaf1"><span class="btnIcon">üçÉ</span> Leaf 1</div>
        <div class="btn small c-leaf2 bettable" data-target="leaf2"><span class="btnIcon">üçÉ</span> Leaf 2</div>
      </div>

      <div class="bonusBottom">
        <div class="btn big c-blue bettable" data-target="lilblues"><span class="btnIcon">üêü</span> LIL BLUES Bonus</div>
        <div class="btn big c-orange bettable" data-target="bigoranges"><span class="btnIcon">üêü</span> BIG ORANGES Bonus</div>
        <div class="btn big c-red bettable" data-target="hugered"><span class="btnIcon">üêü</span> HUGE REDS Bonus</div>
      </div>

      <div class="betRow">
        <button class="undoBtn" id="undoBtn" title="Undo disabled">‚Ü©</button>

        <div class="betSelect" id="betSelect">
          <span id="betValue">0.2</span>
          <span class="betHint">tap to change</span>
          <span class="chev">‚ñæ</span>

          <div class="betMenu" id="betMenu">
            <div class="betOptions">
              <div class="betChip c01" data-bet="0.1">0.1</div>
              <div class="betChip c02" data-bet="0.2">0.2</div>
              <div class="betChip c05" data-bet="0.5">0.5</div>
              <div class="betChip c10" data-bet="1">1</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- TON SHEET -->
  <div class="modalOverlay" id="tonModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle"><img src="ton.png" alt="TON">TON</div>
        <button class="closeBtn" id="tonClose">‚úï</button>
      </div>

      <div class="sheetBtns">
        <div class="sheetAction" id="actionBind"><span>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</span><small id="walletStatus">Not connected</small></div>
        <div class="sheetAction" id="actionDisconnect"><span>–û—Ç–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</span><small>Disconnect</small></div>
        <div class="sheetAction" id="actionDeposit"><span>–î–µ–ø–æ–∑–∏—Ç</span><small>Enter amount</small></div>
        <div class="sheetAction" id="actionWithdraw"><span>–í—ã–≤–æ–¥</span><small>Later</small></div>
      </div>
    </div>
  </div>

  <!-- DEPOSIT INPUT -->
  <div class="modalOverlay" id="depositModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
        <button class="closeBtn" id="depositClose">‚úï</button>
      </div>

      <input id="depositAmount" class="depositInput" type="number" min="0.1" step="0.1" placeholder="–°–∫–æ–ª—å–∫–æ TON –ø–æ–ø–æ–ª–Ω–∏—Ç—å?">

      <div class="row2">
        <div class="sheetAction" id="depositBack">–ù–∞–∑–∞–¥</div>
        <div class="sheetAction" id="depositConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</div>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  function showPopup(title, message){
    if (tg?.showPopup) tg.showPopup({ title, message, buttons:[{type:"ok"}] });
    else alert(`${title}\n\n${message}`);
  }

  // ===== API BASE (fix for PC browser / file://) =====
  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å index.html –∫–∞–∫ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ –±–µ–∑ /api,
  // –∑–∞–ø—Ä–æ—Å—ã –∫ /api/* –ø–∞–¥–∞—é—Ç –∏ —Ç–∞–π–º–µ—Ä/–∫–æ–ª–µ—Å–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "0".
  // –£–∫–∞–∂–∏ –¥–æ–º–µ–Ω Vercel (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä) –≤ window.API_BASE –∏–ª–∏ –ø—Ä—è–º–æ —Ç—É—Ç.
  const API_BASE =
    window.API_BASE ||
    (location.protocol === "file:" ? "https://YOUR-VERCEL-DOMAIN.vercel.app" : "");

  const apiUrl = (p) => `${API_BASE}${p}`;

  /* snow */
  (function initSnow(){
    const box = document.getElementById("snow");
    const flakes = 26;
    for (let i=0;i<flakes;i++){
      const s = document.createElement("span");
      const size = 2 + Math.random()*4;
      s.style.width = size + "px";
      s.style.height = size + "px";
      s.style.left = (Math.random()*100) + "vw";
      s.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
      const dur = 6 + Math.random()*8;
      const delay = Math.random()*-dur;
      s.style.animationDuration = dur + "s";
      s.style.animationDelay = delay + "s";
      box.appendChild(s);
    }
  })();

  /* confetti */
  const confettiLayer = document.getElementById("confetti");
  function burstConfetti(colors){
    const count = 90;
    const W = window.innerWidth || 360;
    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      p.className = "confettiPiece";
      p.style.left = (Math.random() * 100) + "vw";
      p.style.width = (6 + Math.random()*10) + "px";
      p.style.height = (8 + Math.random()*14) + "px";
      p.style.background = colors[(Math.random()*colors.length)|0];
      const dx = (Math.random() - 0.5) * Math.min(420, W*0.8);
      const rot = (360 + Math.random()*1080) * (Math.random() < 0.5 ? -1 : 1);
      const dur = 1200 + Math.random()*1500;
      p.style.setProperty("--dx", dx + "px");
      p.style.setProperty("--rot", rot + "deg");
      p.style.animationDuration = dur + "ms";
      p.style.animationDelay = (Math.random()*120) + "ms";
      confettiLayer.appendChild(p);
      setTimeout(() => p.remove(), dur + 250);
    }
  }
  function celebrateFish(kind){
    if (kind === "lilblues") burstConfetti(["#60a5fa","#93c5fd","#dbeafe","#ffffff"]);
    else if (kind === "bigoranges") burstConfetti(["#fb923c","#fdba74","#ffedd5","#ffffff"]);
    else if (kind === "hugered") burstConfetti(["#fb7185","#fecdd3","#ffe4e6","#ffffff"]);
    else burstConfetti(["#ffffff","#dbeafe","#ffedd5","#ffe4e6"]);
  }

  /* ===========================
     FISHING OVERLAY (2D)
     =========================== */
  const fishingOverlay = document.getElementById("fishingOverlay");
  const fishImg = document.getElementById("testFish");
  const fishMultEl = document.getElementById("fishMult");

  const FISH_SRC = {
    lilblues:   "assets/fishing/fish_blue.png",
    bigoranges: "assets/fishing/fish_orange.png",
    hugered:    "assets/fishing/fish_red.png",
  };
  const FISH_MULT = { lilblues:2, bigoranges:5, hugered:10 };

  // ===== Game pause during fishing scene =====
  let overlayActive = false;

  function setGamePaused(paused){
    overlayActive = !!paused;

    // —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –æ—Å–Ω–æ–≤–Ω–æ–π UI (–∏ —Ñ–æ–Ω –ø–æ–¥ –Ω–∏–º) ‚Äî –ø–æ–≤–µ—Ä—Ö –±—É–¥–µ—Ç —Ä—ã–±–∞–ª–∫–∞
    const idsToHide = ["snow","confetti","tonModal","depositModal"];
    idsToHide.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = paused ? "none" : "";
    });

    const wheelWrap = document.querySelector(".wheelWrap");
    const bottomUI  = document.querySelector(".bottomUI");
    const hudRight  = document.querySelector(".hudRight");
    const leftHUD   = document.querySelector(".leftHUD");

    if (wheelWrap) wheelWrap.style.display = paused ? "none" : "";
    if (bottomUI)  bottomUI.style.display  = paused ? "none" : "";
    if (hudRight)  hudRight.style.display  = paused ? "none" : "";
    if (leftHUD)   leftHUD.style.display   = paused ? "none" : "";

    // –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Ç–∞–≤–∫–∞–º
    document.querySelectorAll(".bettable, .betSelect, .undoBtn").forEach(btn=>{
      btn.style.pointerEvents = paused ? "none" : "";
      btn.style.opacity = paused ? "0.75" : "";
    });
  }

  let fishingBusy = false;

  function playFishingScene(kind){
    if (fishingBusy) return;
    if (!fishingOverlay || !fishImg) return;

    const src = FISH_SRC[kind];
    if (!src) return;

    fishingBusy = true;
    setGamePaused(true);

    fishImg.src = src;

    if (fishMultEl){
      const m = FISH_MULT[kind] || 1;
      fishMultEl.textContent = "x" + m;
      fishMultEl.style.opacity = "0";
      fishMultEl.style.transform = "translate(-50%,-50%) scale(0.7)";
    }

    fishingOverlay.style.display = "block";
    fishingOverlay.style.opacity = "0";
    fishingOverlay.style.transition = "opacity 550ms ease";
    fishImg.style.opacity = "0";
    fishImg.style.transform = "translate(-50%,-50%) scale(0.35) rotate(-18deg)";
    fishImg.style.transition = "transform 950ms cubic-bezier(.15,.9,.25,1), opacity 250ms ease";

    requestAnimationFrame(()=>{
      fishingOverlay.style.opacity = "1";
      setTimeout(()=>{
        fishImg.style.opacity = "1";
        fishImg.style.transform = "translate(-50%,-50%) scale(1.0) rotate(8deg)";
      }, 380);

      if (fishMultEl){
        setTimeout(()=>{
          fishMultEl.style.transition = "transform 520ms cubic-bezier(.2,1.25,.25,1), opacity 200ms ease";
          fishMultEl.style.opacity = "1";
          fishMultEl.style.transform = "translate(-50%,-50%) scale(1.05)";
        }, 1100);
      }
    });

    // –ø–æ–∫–∞–∑–∞—Ç—å ~2.3 —Å–µ–∫, –∑–∞—Ç–µ–º —Å–∫—Ä—ã—Ç—å
    setTimeout(()=>{
      fishingOverlay.style.opacity = "0";
      setTimeout(()=>{
        fishingOverlay.style.display = "none";
        fishingBusy = false;
        setGamePaused(false);
      }, 650);
    }, 2300);
  }

  /* ton core helpers */
  let __tonCore = null;
  async function tonCore(){
    if (!__tonCore) __tonCore = await import("https://esm.sh/@ton/core@0.58.0");
    return __tonCore;
  }
  async function toRaw(addr){
    const a = String(addr || "").trim();
    if (!a) return null;
    const { Address } = await tonCore();
    return Address.parse(a).toRawString();
  }
  async function toFriendly(addr){
    const a = String(addr || "").trim();
    if (!a) return null;
    const { Address } = await tonCore();
    return Address.parse(a).toString({ urlSafe: true, bounceable: false, testOnly: false });
  }
  function bytesToBase64(bytes){
    let bin = "";
    for (const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin);
  }
  async function commentToBocBase64(comment){
    const { beginCell } = await tonCore();
    const cell = beginCell().storeUint(0, 32).storeStringTail(String(comment || "")).endCell();
    const boc = cell.toBoc({ idx: false });
    return bytesToBase64(boc);
  }
  function shortAddr(a){ return a ? (a.slice(0,6) + "..." + a.slice(-6)) : ""; }

  /* wallet LS */
  function getWalletRawLS(){
    const ls = (localStorage.getItem("walletRaw") || "").trim();
    return ls || null;
  }
  async function setWalletFromTonConnect(wallet){
    const addr = (wallet?.account?.address || "").trim();
    if (!addr){
      localStorage.removeItem("walletRaw");
      localStorage.removeItem("walletFriendly");
      return;
    }
    const raw = await toRaw(addr);
    localStorage.setItem("walletRaw", raw);
    const fr = await toFriendly(raw);
    if (fr) localStorage.setItem("walletFriendly", fr);
  }
  async function getWalletFriendlyLS(){
    const cached = (localStorage.getItem("walletFriendly") || "").trim();
    if (cached) return cached;
    const raw = getWalletRawLS();
    if (!raw) return null;
    const fr = await toFriendly(raw);
    if (fr) localStorage.setItem("walletFriendly", fr);
    return fr;
  }

  async function getAddressRawForApi(){
    const raw = getWalletRawLS();
    if (!raw) return null;
    return raw;
  }

  const fmt = (n) => {
    const x = Number(n || 0);
    if (Number.isNaN(x)) return "0";
    if (Math.abs(x) >= 1) return x.toFixed(2).replace(/\.00$/,"");
    return x.toFixed(2);
  };

  /* TON CONNECT UI */
  const tonConnectBtn = document.getElementById("tonConnectBtn");
  const tonBtnText = document.getElementById("tonBtnText");
  const walletStatus = document.getElementById("walletStatus");
  const tonModal = document.getElementById("tonModal");
  const tonClose = document.getElementById("tonClose");

  const depositModal = document.getElementById("depositModal");
  const depositClose = document.getElementById("depositClose");
  const depositBack = document.getElementById("depositBack");
  const depositConfirm = document.getElementById("depositConfirm");
  const depositAmount = document.getElementById("depositAmount");

  const actionBind = document.getElementById("actionBind");
  const actionDisconnect = document.getElementById("actionDisconnect");
  const actionDeposit = document.getElementById("actionDeposit");
  const actionWithdraw = document.getElementById("actionWithdraw");

  const tonui = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: "tonconnect-manifest.json" });

  function openTonSheet(){ tonModal.classList.add("open"); }
  function closeTonSheet(){ tonModal.classList.remove("open"); }

  function openDepositSheet(){
    tonModal.classList.remove("open");
    depositModal.classList.add("open");
    depositAmount.value = "";
    setTimeout(()=>depositAmount.focus(), 50);
  }
  function closeDepositSheet(){ depositModal.classList.remove("open"); }

  tonConnectBtn.addEventListener("click", openTonSheet);
  tonClose.addEventListener("click", closeTonSheet);
  tonModal.addEventListener("click", (e)=>{ if (e.target === tonModal) closeTonSheet(); });

  depositClose.addEventListener("click", closeDepositSheet);
  depositBack.addEventListener("click", ()=>{ closeDepositSheet(); openTonSheet(); });
  depositModal.addEventListener("click", (e)=>{ if (e.target === depositModal) closeDepositSheet(); });

  async function syncWalletUI(){
    const raw = getWalletRawLS();
    if (!raw){
      tonBtnText.textContent = "TON connect";
      walletStatus.textContent = "Not connected";
      return;
    }
    const fr = await getWalletFriendlyLS();
    tonBtnText.textContent = shortAddr(fr || raw);
    walletStatus.textContent = shortAddr(fr || raw);
  }

  async function bindWalletOnServer(){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{
      await fetch(apiUrl(`/api/bind_wallet?t=${Date.now()}`), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ address: raw })
      });
    }catch{}
  }

  tonui.onStatusChange(async (wallet) => {
    await setWalletFromTonConnect(wallet);
    await syncWalletUI();
    if (getWalletRawLS()) await bindWalletOnServer();
    await refreshBalance();
  });

  actionBind.addEventListener("click", async ()=>{
    try{
      await tonui.connectWallet();
    }catch{}
  });

  actionDisconnect.addEventListener("click", async ()=>{
    try{ await tonui.disconnect(); }catch{}
    localStorage.removeItem("walletRaw");
    localStorage.removeItem("walletFriendly");
    await syncWalletUI();
    await refreshBalance();
  });

  actionDeposit.addEventListener("click", ()=>{
    if (!getWalletRawLS()){
      showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫.");
      return;
    }
    openDepositSheet();
  });

  actionWithdraw.addEventListener("click", ()=>{
    showPopup("–í—ã–≤–æ–¥", "–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.");
  });

  /* balance */
  const balanceValue = document.getElementById("balanceValue");
  let balanceTonCache = 0;

  function setBalanceTonUI(v){
    balanceTonCache = Number(v || 0);
    balanceValue.textContent = fmt(balanceTonCache);
  }

  async function refreshBalance(){
    const raw = await getAddressRawForApi();
    if (!raw){
      setBalanceTonUI(0);
      return;
    }
    try{
      const r = await fetch(apiUrl(`/api/balance?address=${encodeURIComponent(raw)}&t=${Date.now()}`), { cache:"no-store" });
      const j = await r.json().catch(()=>({}));
      if (r.ok && typeof j.balanceTon === "number") setBalanceTonUI(j.balanceTon);
    }catch{}
  }

  /* deposit flow (intent + confirm + resume) */
  async function confirmDepositTry(intentId, addressRaw){
    const url = apiUrl(`/api/confirm_deposit?intentId=${encodeURIComponent(intentId)}&address=${encodeURIComponent(addressRaw)}&t=${Date.now()}`);
    const r = await fetch(url, { cache:"no-store" });
    const j = await r.json().catch(()=>({}));
    if (!r.ok) return false;
    if (j?.status === "credited"){
      localStorage.removeItem("lastDepositIntentId");
      await refreshBalance();
      showPopup("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.");
      return true;
    }
    return false;
  }

  async function resumeDepositsSilently(){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{ await fetch(apiUrl(`/api/deposit_resume?address=${encodeURIComponent(raw)}&t=${Date.now()}`), { cache:"no-store" }); }catch{}
  }

  async function createDepositIntent(amountTon){
    const raw = await getAddressRawForApi();
    if (!raw) return null;

    const r = await fetch(apiUrl(`/api/deposit_intent?t=${Date.now()}`), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address: raw, amountTon: Number(amountTon) })
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok) return null;
    return j;
  }

  depositConfirm.addEventListener("click", async ()=>{
    const amount = Number(depositAmount.value || 0);
    if (!amount || amount < 0.1){
      showPopup("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "–ú–∏–Ω–∏–º—É–º 0.1 TON");
      return;
    }
    const raw = await getAddressRawForApi();
    if (!raw){
      showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫.");
      return;
    }

    const intent = await createDepositIntent(amount);
    if (!intent?.to || !intent?.amountNano || !intent?.comment || !intent?.intentId){
      showPopup("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂.");
      return;
    }

    localStorage.setItem("lastDepositIntentId", intent.intentId);

    try{
      const payload = await commentToBocBase64(intent.comment);
      await tonui.sendTransaction({
        validUntil: Math.floor(Date.now()/1000) + 300,
        messages: [{ address: intent.to, amount: String(intent.amountNano), payload }]
      });
      closeDepositSheet();
      showPopup("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...");
      confirmDepositTry(intent.intentId, raw).catch(()=>{});
    }catch(e){
      showPopup("–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", "–û—Ç–º–µ–Ω–µ–Ω–æ.");
    }
  });

  /* ========= BET UI ========= */
  const betSelect = document.getElementById("betSelect");
  const betValue = document.getElementById("betValue");
  const betMenu = document.getElementById("betMenu");

  let currentBet = 0.2;
  const totals = new Map(); // target -> ton total

  function closeBetMenu(){ betMenu.classList.remove("open"); }
  function toggleBetMenu(){ betMenu.classList.toggle("open"); }

  betSelect.addEventListener("click", (e) => { e.stopPropagation(); toggleBetMenu(); });
  betMenu.querySelectorAll(".betChip").forEach(chip => {
    chip.addEventListener("click", (e) => {
      e.stopPropagation();
      currentBet = Number(chip.dataset.bet);
      betValue.textContent = fmt(currentBet);
      closeBetMenu();
    });
  });
  document.addEventListener("click", () => closeBetMenu());

  function renderTotalOnButton(target){
    const btn = document.querySelector(`.bettable[data-target="${target}"]`);
    if (!btn) return;
    const total = totals.get(target) || 0;
    const old = btn.querySelector(".placedBet");
    if (old) old.remove();
    if (total > 0){
      const badge = document.createElement("div");
      badge.className = "placedBet";
      badge.textContent = fmt(total);
      btn.appendChild(badge);
    }
  }
  function clearAllBetsUI(){
    totals.clear();
    document.querySelectorAll(".bettable").forEach(btn => {
      const badge = btn.querySelector(".placedBet");
      if (badge) badge.remove();
    });
  }

  /* ========= SERVER STATE ========= */
  let S = null;

  const hudMain = document.getElementById("hudMain");

  // server time offset (ms)
  let timeOffsetMs = 0;
  function serverTimeNow(){ return Date.now() + timeOffsetMs; }

  // round
  let roundId = 0;
  let startAt = 0;
  let endAt = 0;
  let spinStartAt = 0;
  let spinDurMs = 0;

  let lastResolvedRoundId = null;

  function applyState(st){
    if (!st) return;
    S = st;

    // clock sync
    if (typeof st.serverNow === "number"){
      timeOffsetMs = st.serverNow - Date.now();
    }

    if (st.round){
      roundId = Number(st.round.roundId || 0);
      startAt = Number(st.round.startAt || 0);
      endAt = Number(st.round.endAt || 0);
      spinStartAt = Number(st.round.spinStartAt || startAt);
      spinDurMs = Number(st.round.spinDurMs || 0);
    }

    // history
    if (Array.isArray(st.history)){
      historyList = st.history.slice(0, 18);
      renderHistory();
    }
  }

  async function fetchState(){
    const r = await fetch(apiUrl(`/api/state?t=${Date.now()}`), { cache:"no-store" });
    if (!r.ok) throw new Error("api_state_error");
    return await r.json();
  }

  async function addBet(target, amountTon){
    if (!getWalletRawLS()){ showPopup("–°—Ç–∞–≤–∫–∏", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }
    if (!S?.round?.roundId && S?.round?.roundId !== 0){ showPopup("–°—Ç–∞–≤–∫–∏", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–∞."); return; }

    const now = serverTimeNow();
    if (overlayActive){
      showPopup("–°—Ç–∞–≤–∫–∏", "–ò–¥—ë—Ç –±–æ–Ω—É—Å-—Å—Ü–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥.");
      return;
    }
    if (now >= spinStartAt && now <= endAt){
      showPopup("–°—Ç–∞–≤–∫–∏", "–í–æ –≤—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è —Å—Ç–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.");
      return;
    }

    const raw = await getAddressRawForApi();
    const roundId = Number(S.round.roundId);
    const amountNano = Math.trunc(Number(amountTon) * 1e9);

    if (balanceTonCache + 1e-9 < amountTon){
      showPopup("–ë–∞–ª–∞–Ω—Å", `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${fmt(amountTon)} TON`);
      return;
    }

    const r = await fetch(apiUrl(`/api/bet_place?t=${Date.now()}`), {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address: raw, roundId, target, amountNano })
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok){
      if (j?.error === "insufficient") showPopup("–ë–∞–ª–∞–Ω—Å", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.");
      else showPopup("–°—Ç–∞–≤–∫–∏", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å.");
      return;
    }

    if (typeof j.balanceTon === "number") setBalanceTonUI(j.balanceTon);
    else await refreshBalance();

    const prev = totals.get(target) || 0;
    const next = Math.round((prev + amountTon) * 10) / 10;
    totals.set(target, next);
    renderTotalOnButton(target);
  }

  document.querySelectorAll(".bettable").forEach(btn => {
    btn.addEventListener("click", (e) => { e.stopPropagation(); addBet(btn.dataset.target, currentBet); });
  });

  async function settleBetsIfNeeded(){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{
      const r = await fetch(apiUrl(`/api/bet_settle?t=${Date.now()}`), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ address: raw })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok) return;

      if (Array.isArray(j.settled) && j.settled.length) clearAllBetsUI();
      if (j.creditedTonTotal && j.creditedTonTotal > 0) await refreshBalance();
    }catch{}
  }

  /* ========= WHEEL SYNC ========= */
  const N = 53;
  const step = (Math.PI*2)/N;
  const startOffset = -Math.PI/2;

  const IDX_HUGE = 0;
  const IDX_ORANGES = [13, 39];
  const IDX_BLUES   = [7, 20, 33, 46];

  const css = getComputedStyle(document.documentElement);
  const COLORS = {
    red:    css.getPropertyValue('--red').trim(),
    orange: css.getPropertyValue('--orange').trim(),
    blue:   css.getPropertyValue('--blue').trim(),
    leaf1:  css.getPropertyValue('--leaf1').trim(),
    leaf2:  css.getPropertyValue('--leaf2').trim(),
  };

  const sectors = Array.from({length:N}, ()=>null);
  sectors[IDX_HUGE] = { kind:"hugered", label:"HUGE REDS", fill:COLORS.red, text:"#fff", icon:"fish" };
  for (const i of IDX_ORANGES) sectors[i] = { kind:"bigoranges", label:"BIG ORANGES", fill:COLORS.orange, text:"#1b1b1b", icon:"fish" };
  for (const i of IDX_BLUES)   sectors[i] = { kind:"lilblues", label:"LIL BLUES", fill:COLORS.blue, text:"#fff", icon:"fish" };

  let leaf1Left = 23, leaf2Left = 23;
  let toggle = 0;
  for (let i=0;i<N;i++){
    if (sectors[i]) continue;
    const wantLeaf1 = (toggle % 2 === 0);
    if (wantLeaf1 && leaf1Left > 0){
      sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
      leaf1Left--;
    } else if (!wantLeaf1 && leaf2Left > 0){
      sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
      leaf2Left--;
    } else {
      if (leaf1Left > 0){
        sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
        leaf1Left--;
      } else {
        sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
        leaf2Left--;
      }
    }
    toggle++;
  }

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2;

  const outerR = Math.min(W,H)*0.47;
  const innerR = outerR*0.22;

  function normalize(a){
    const t = Math.PI*2;
    return ((a%t)+t)%t;
  }
  function wrapNear(ref, value){
    const t = Math.PI*2;
    let v = value;
    v += Math.round((ref - v)/t)*t;
    return v;
  }

  const pointerWorld = -Math.PI/2;
  function indexAtPointer(angle){
    const rel = normalize(pointerWorld - angle - startOffset);
    return Math.floor(rel / step);
  }

  function drawFishIcon(x,y,scale,fill){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);
    ctx.fillStyle = fill;
    ctx.beginPath();
    ctx.ellipse(0,0, 22, 14, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(22,0);
    ctx.lineTo(36,10);
    ctx.lineTo(36,-10);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
  function drawLeafIcon(x,y,scale,fill){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);
    ctx.fillStyle = fill;
    ctx.beginPath();
    ctx.moveTo(0,-18);
    ctx.quadraticCurveTo(18,-6, 6,10);
    ctx.quadraticCurveTo(-6,26, -16,12);
    ctx.quadraticCurveTo(-26,-4, 0,-18);
    ctx.fill();
    ctx.restore();
  }

  function drawWheel(angle, hiIndex){
    ctx.clearRect(0,0,W,H);

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angle + startOffset);

    for (let i=0;i<N;i++){
      const s = sectors[i];
      const a0 = i*step;
      const a1 = (i+1)*step;

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0, outerR, a0, a1);
      ctx.closePath();
      ctx.fillStyle = s.fill;
      ctx.fill();

      if (hiIndex === i){
        ctx.save();
        ctx.globalAlpha = 0.10;
        ctx.fillStyle = "#ffffff";
        ctx.fill();
        ctx.restore();
      }

      const mid = (a0+a1)/2;
      const ix = Math.cos(mid) * (outerR*0.64);
      const iy = Math.sin(mid) * (outerR*0.64);

      if (s.icon === "fish"){
        drawFishIcon(ix, iy, 0.55, "rgba(255,255,255,.92)");
      } else {
        drawLeafIcon(ix, iy, 0.55, "rgba(255,255,255,.60)");
      }
    }

    // inner
    ctx.beginPath();
    ctx.arc(0,0, innerR, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,.80)";
    ctx.fill();
    ctx.restore();
  }

  // motion model
  const SPIN_TURNS = 8;
  const ANGLE_SMOOTH = 0.12;

  let renderAngle = 0;

  function indexToAngle(idx){
    const mid = (idx + 0.5)*step;
    return pointerWorld - startOffset - mid;
  }

  function computeTrueAngle(serverNow){
    if (!S?.round) return renderAngle;

    const t0 = spinStartAt;
    const t1 = endAt;
    const resultIndex = Number(S.round.resultIndex ?? 0);

    if (serverNow <= t0){
      return renderAngle;
    }

    const targetAngle = indexToAngle(resultIndex);

    const dur = Math.max(1, t1 - t0);
    const p = Math.min(1, Math.max(0, (serverNow - t0)/dur));

    const ease = 1 - Math.pow(1-p, 3);

    const from = wrapNear(targetAngle, renderAngle);
    const total = (SPIN_TURNS * Math.PI*2) + (targetAngle - from);
    return from + total * ease;
  }

  function updatePointerFlex(now){
    const rod = document.getElementById("pointerRod");
    if (!rod) return;

    const speed = Math.abs(renderAngle - lastRenderAngle) / (Math.max(16, now - lastNow));
    const flex = Math.min(1, speed * 90);
    rod.style.transform = `translateX(-50%) rotate(${flex*14}deg)`;
    lastRenderAngle = renderAngle;
    lastNow = now;
  }
  let lastRenderAngle = 0;
  let lastNow = performance.now();

  // HUD + HISTORY
  let historyList = [];

  function renderHistory(){
    const bar = document.getElementById("historyBar");
    if (!bar) return;
    bar.innerHTML = "";
    for (const it of historyList){
      const chip = document.createElement("div");
      chip.className = "chip " + (it?.isFish ? "fish" : "leaf");
      chip.style.background = it?.color || "rgba(255,255,255,.6)";
      bar.appendChild(chip);
    }
  }

  function setHUD(){
    const sn = serverTimeNow();
    if (!S?.round){
      hudMain.textContent = "0";
      return;
    }
    const remain = Math.max(0, Math.ceil((spinStartAt - sn)/1000));
    hudMain.textContent = String(remain);
  }

  // end-of-spin actions
  let lastSpinProcessedRound = null;

  function maybeEndOfSpinActions(serverNow){
    if (!S?.round) return;
    const rId = Number(S.round.roundId || 0);

    if (serverNow < endAt) return;
    if (lastSpinProcessedRound === rId) return;

    lastSpinProcessedRound = rId;

    const kind = sectors[Number(S.round.resultIndex ?? 0)]?.kind || "leaf1";

    // –µ—Å–ª–∏ —Ä—ã–±–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω—É
    if (kind === "lilblues" || kind === "bigoranges" || kind === "hugered"){
      celebrateFish(kind);
      playFishingScene(kind);
    }

    // –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø–∏–Ω–∞ –ø—Ä–æ—Å–∏–º —Å–µ—Ä–≤–µ—Ä –∑–∞—Å–µ—Ç–ª–∏—Ç—å —Å—Ç–∞–≤–∫–∏
    settleBetsIfNeeded().catch(()=>{});
  }

  function raf(now){
    const sn = serverTimeNow();
    const trueAngle = computeTrueAngle(sn);

    const diff = Math.abs(trueAngle - renderAngle);
    if (diff > Math.PI * 1.5) {
      renderAngle = trueAngle;
    } else {
      renderAngle = renderAngle + (trueAngle - renderAngle) * ANGLE_SMOOTH;
    }

    const hi = indexAtPointer(renderAngle);
    drawWheel(renderAngle, hi);
    updatePointerFlex(now);
    setHUD();
    maybeEndOfSpinActions(sn);

    requestAnimationFrame(raf);
  }

  let stateFails = 0;
  async function syncLoop(){
    try{
      const st = await fetchState();
      applyState(st);
      stateFails = 0;
    }catch{
      stateFails++;
      if (stateFails > 5){
        if (hudMain) hudMain.textContent = "‚Äî";
      }
    }
  }

  /* init */
  (async function initAll(){
    await syncWalletUI();
    if (getWalletRawLS()) await bindWalletOnServer();
    await refreshBalance();

    await resumeDepositsSilently();

    const lastIntent = (localStorage.getItem("lastDepositIntentId") || "").trim();
    if (lastIntent && getWalletRawLS()){
      const raw = await getAddressRawForApi();
      if (raw) confirmDepositTry(lastIntent, raw).catch(()=>{});
    }

    await settleBetsIfNeeded();

    drawWheel(renderAngle, null);
    renderHistory();

    await syncLoop();

    setInterval(syncLoop, 1100);
    setInterval(refreshBalance, 5000);
    setInterval(resumeDepositsSilently, 12000);
    setInterval(settleBetsIfNeeded, 6500);

    requestAnimationFrame(raf);
  })();
</script>

<!-- FISHING SCENE OVERLAY -->
<div id="fishingOverlay" style="
  position:fixed;
  inset:0;
  background:url('assets/fishing/bg_lake.jpg') center/cover no-repeat;
  z-index:9999;
  display:none;
">
  <div style="position:absolute; inset:0; background:rgba(0,0,0,0.10)"></div>

  <img id="testFish"
       src="assets/fishing/fish_blue.png"
       style="
         position:absolute;
         left:58%;
         top:62%;
         transform:translate(-50%,-50%);
         width:200px;
         height:auto;
         filter: drop-shadow(0 18px 35px rgba(0,0,0,0.55));
       ">

  <div id="fishMult" style="
    position:absolute;
    left:58%;
    top:62%;
    transform:translate(-50%,-50%);
    font-size:56px;
    font-weight:1000;
    color:#fff;
    text-shadow: 0 4px 0 rgba(0,0,0,.6), 0 14px 30px rgba(0,0,0,.35);
    -webkit-text-stroke: 3px rgba(0,0,0,.35);
    opacity:0;
    pointer-events:none;
  ">x2</div>
</div>

</body>
</html>
