<!doctype html>
<html lang="ru"><!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IceFishing Wheel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0b1220; --card:#121b2f; --text:#e7eefc; --muted:#9bb0d0; --accent:#5eead4; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 30% 0%, #15224a 0%, var(--bg) 55%);
      color:var(--text);
      padding:16px;
    }
    .wrap{ max-width:520px; margin:0 auto; }
    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    h1{ font-size:18px; margin:0 0 10px; display:flex; gap:8px; align-items:center; }
    .sub{ color:var(--muted); font-size:13px; margin:0 0 12px; }
    .stage{ position:relative; display:flex; justify-content:center; align-items:center; padding:12px 0 6px; }
    canvas{ width:min(360px, 92vw); height:min(360px, 92vw); }
    .pointer{
      position:absolute; top:2px;
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:24px solid var(--accent);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
    }
    .controls{ display:flex; gap:10px; margin-top:12px; }
    button{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      transition:.15s transform, .15s background;
    }
    button:active{ transform: scale(.98); }
    button.primary{
      background: linear-gradient(135deg, rgba(94,234,212,.25), rgba(94,234,212,.05));
      border-color: rgba(94,234,212,.35);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .result{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      display:flex; justify-content:space-between; align-items:center;
      gap:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(94,234,212,.14);
      border:1px solid rgba(94,234,212,.25);
      color: var(--accent);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .small{ font-size:12px; color:var(--muted); margin-top:8px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .grid code{ color:var(--text); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üé£ –ö–æ–ª–µ—Å–æ —É–ª–æ–≤–∞</h1>
      <p class="sub">–ù–∞–∂–º–∏ ¬´SPIN¬ª ‚Äî –∫–æ–ª–µ—Å–æ –∫—Ä—É—Ç–∏—Ç—Å—è, –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è –∏ –≤—ã–¥–∞—ë—Ç —Ä—ã–±—É.</p>

      <div class="stage">
        <div class="pointer"></div>
        <canvas id="wheel" width="600" height="600"></canvas>
      </div>

      <div class="controls">
        <button id="spinBtn" class="primary">‚ñ∂ SPIN</button>
        <button id="resetBtn">‚Ü∫ Reset</button>
      </div>

      <div class="result" id="resultBox">
        <div>
          <div style="font-weight:800">–†–µ–∑—É–ª—å—Ç–∞—Ç: <span id="fishName">‚Äî</span></div>
          <div class="small">–°–µ–∫—Ç–æ—Ä: <span id="sectorIndex">‚Äî</span></div>
        </div>
        <div class="pill" id="statusPill">READY</div>
      </div>

      <div class="grid">
        <div>URL: <code id="urlLabel"></code></div>
        <div>User: <code id="userLabel"></code></div>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp init (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ)
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.setHeaderColor?.("#0b1220");
    }
    document.getElementById("urlLabel").innerText = location.host;
    document.getElementById("userLabel").innerText = tg?.initDataUnsafe?.user?.username || "‚Äî";

    // ==== –ù–ê–°–¢–†–û–ô–ö–ò –ö–û–õ–ï–°–ê ====
    // –†–∞–≤–Ω—ã–µ "—è—á–µ–π–∫–∏" (—Å–µ–∫—Ç–æ—Ä—ã). –ú–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Ä—ã–± –∫–∞–∫ —Ö–æ—á–µ—à—å.
    const sectors = [
      { name: "–û–∫—É–Ω—å" },
      { name: "–©—É–∫–∞" },
      { name: "–°—É–¥–∞–∫" },
      { name: "–ö–∞—Ä–∞—Å—å" },
      { name: "–õ–µ—â" },
      { name: "–§–æ—Ä–µ–ª—å" },
      { name: "–ù–∞–ª–∏–º" },
      { name: "–ü–ª–æ—Ç–≤–∞" },
      { name: "–°–æ–º" },
      { name: "–•–∞—Ä–∏—É—Å" },
      { name: "–ì–æ–ª–∞–≤–ª—å" },
      { name: "–°–∞–∑–∞–Ω" },
    ];
    // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Ä–æ–≤–Ω–æ –∫–∞–∫ "—Å–µ—Ç–∫–∞" ‚Äî –¥–µ—Ä–∂–∏–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–µ—Å:
    const equalWeights = sectors.map(() => 1);

    // ==== CANVAS DRAW ====
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const cx = W / 2, cy = H / 2;
    const radius = Math.min(W, H) * 0.44;
    const inner = radius * 0.12;

    const spinBtn = document.getElementById("spinBtn");
    const resetBtn = document.getElementById("resetBtn");
    const fishNameEl = document.getElementById("fishName");
    const sectorIndexEl = document.getElementById("sectorIndex");
    const statusPill = document.getElementById("statusPill");

    let spinning = false;
    let angle = 0; // radians
    let lastWinner = null;

    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
    function pickWeightedIndex(weights) {
      const total = sum(weights);
      let r = Math.random() * total;
      for (let i = 0; i < weights.length; i++) {
        r -= weights[i];
        if (r <= 0) return i;
      }
      return weights.length - 1;
    }

    function drawWheel(highlightIndex = null) {
      ctx.clearRect(0,0,W,H);

      // —Ñ–æ–Ω –∫—Ä—É–≥–∞
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      const n = sectors.length;
      const step = (Math.PI * 2) / n;

      for (let i=0;i<n;i++){
        const a0 = i*step;
        const a1 = a0 + step;

        // —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–ª–∏–≤–∫–∏
        const isEven = i % 2 === 0;
        const base = isEven ? "rgba(255,255,255,0.06)" : "rgba(94,234,212,0.08)";
        const hi = "rgba(94,234,212,0.18)";
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,a0,a1);
        ctx.closePath();
        ctx.fillStyle = (highlightIndex===i) ? hi : base;
        ctx.fill();

        // –≥—Ä–∞–Ω–∏—Ü–∞ —Å–µ–∫—Ç–æ—Ä–∞
        ctx.strokeStyle = "rgba(255,255,255,0.10)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // —Ç–µ–∫—Å—Ç
        const mid = (a0+a1)/2;
        ctx.save();
        ctx.rotate(mid);
        ctx.translate(radius*0.62, 0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle = "rgba(231,238,252,0.95)";
        ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(sectors[i].name, 0, 0);
        ctx.restore();
      }

      // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥
      ctx.beginPath();
      ctx.arc(0,0, inner*2.2, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // ‚Äú–≥–∞–π–∫–∞‚Äù –ø–æ —Ü–µ–Ω—Ç—Ä—É
      ctx.beginPath();
      ctx.arc(0,0, inner, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.fill();

      ctx.restore();

      // —Ä–∞–º–∫–∞ –≤–Ω–µ—à–Ω—è—è
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 6;
      ctx.stroke();
    }

    function normalizeAngle(a){
      const two = Math.PI*2;
      return ((a % two) + two) % two;
    }

    // –£–∫–∞–∑–∞—Ç–µ–ª—å —Å–≤–µ—Ä—Ö—É (12 —á–∞—Å–æ–≤). –û–Ω "—Å–º–æ—Ç—Ä–∏—Ç" –Ω–∞ —É–≥–æ–ª -90¬∞ (–≤ canvas —ç—Ç–æ -Math.PI/2).
    // –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —Å–µ–∫—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–¥ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º.
    function getIndexAtPointer(currentAngle){
      const n = sectors.length;
      const step = (Math.PI*2)/n;

      // —É–≥–æ–ª —É–∫–∞–∑–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–ª–µ—Å–∞:
      // –º—ã –≤—Ä–∞—â–∞–µ–º –∫–æ–ª–µ—Å–æ –Ω–∞ angle, –∑–Ω–∞—á–∏—Ç "–º–∏—Ä" –Ω–∞ -angle.
      // pointer –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–≤–µ—Ä—Ö => -PI/2
      const pointerWorld = -Math.PI/2;

      // –∫–∞–∫–æ–π —É–≥–æ–ª –∫–æ–ª–µ—Å–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–¥ pointer:
      const a = normalizeAngle(pointerWorld - currentAngle);

      // –∏–Ω–¥–µ–∫—Å —Å–µ–∫—Ç–æ—Ä–∞:
      const idx = Math.floor(a / step);
      return Math.max(0, Math.min(n-1, idx));
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è —Å–æ ‚Äú—Å–±—Ä–∞—Å—ã–≤–∞–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏‚Äù (easeOutCubic)
    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    async function spin(){
      if (spinning) return;
      spinning = true;
      statusPill.textContent = "SPINNING";
      spinBtn.disabled = true;

      // –í—ã–±–∏—Ä–∞–µ–º –∑–∞—Ä–∞–Ω–µ–µ –≤—ã–∏–≥—Ä—ã—à–Ω—ã–π –∏–Ω–¥–µ–∫—Å (—Å–µ–π—á–∞—Å –≤–µ—Å–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ)
      const winnerIndex = pickWeightedIndex(equalWeights);

      // –ß—Ç–æ–±—ã –¥–æ–∫—Ä—É—Ç–∏—Ç—å –∏–º–µ–Ω–Ω–æ –Ω–∞ winner:
      // –í—ã—á–∏—Å–ª—è–µ–º, –∫–∞–∫–æ–π —É–≥–æ–ª –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã winner –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–¥ pointer.
      const n = sectors.length;
      const step = (Math.PI*2)/n;

      // –¶–µ–Ω—Ç—Ä –≤—ã–∏–≥—Ä—ã—à–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ (–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∫–æ–ª–µ—Å–∞)
      const winnerCenter = (winnerIndex + 0.5) * step;

      // Pointer –≤–≤–µ—Ä—Ö (-PI/2). –•–æ—Ç–∏–º: (pointerWorld - finalAngle) == winnerCenter (mod 2œÄ)
      const pointerWorld = -Math.PI/2;
      let targetAngle = pointerWorld - winnerCenter;

      // –î–æ–±–∞–≤–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ + –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞–Ω–¥–æ–º –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ç–æ—Ä–∞
      const extraTurns = 6 + Math.floor(Math.random()*4); // 6-9
      const jitter = (Math.random() - 0.5) * step * 0.35; // –Ω–µ–±–æ–ª—å—à–æ–π —Å–¥–≤–∏–≥, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ç–æ—Ä–∞
      targetAngle = targetAngle + jitter - extraTurns * Math.PI * 2;

      const start = angle;
      const end = targetAngle;

      const duration = 4200 + Math.floor(Math.random()*900); // ms
      const t0 = performance.now();

      await new Promise(resolve => {
        function frame(now){
          const t = Math.min(1, (now - t0)/duration);
          const k = easeOutCubic(t);
          angle = start + (end - start) * k;

          // —Ä–∏—Å—É–µ–º —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–µ–∫—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –ø–æ–¥ pointer
          const idx = getIndexAtPointer(angle);
          drawWheel(idx);

          if (t < 1) requestAnimationFrame(frame);
          else resolve();
        }
        requestAnimationFrame(frame);
      });

      // –§–∏–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      const finalIdx = getIndexAtPointer(angle);
      lastWinner = finalIdx;

      fishNameEl.textContent = sectors[finalIdx].name;
      sectorIndexEl.textContent = String(finalIdx + 1) + " / " + sectors.length;
      statusPill.textContent = "WIN!";
      drawWheel(finalIdx);

      // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ tg.sendData (–ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä)
      // tg?.sendData?.(JSON.stringify({ fish: sectors[finalIdx].name, idx: finalIdx }));

      spinBtn.disabled = false;
      spinning = false;
    }

    function reset(){
      if (spinning) return;
      angle = 0;
      lastWinner = null;
      fishNameEl.textContent = "‚Äî";
      sectorIndexEl.textContent = "‚Äî";
      statusPill.textContent = "READY";
      drawWheel(null);
    }

    spinBtn.addEventListener("click", spin);
    resetBtn.addEventListener("click", reset);

    // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    drawWheel(null);
  </script>
</body>
</html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IceFishing</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="font-family: system-ui; padding: 16px;">
  <h2>IceFishing WebApp üé£</h2>
  <p id="user">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    document.getElementById("user").innerText =
      "User: " + JSON.stringify(tg.initDataUnsafe?.user || null);
  </script>
</body>
</html>
