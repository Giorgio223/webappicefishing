<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IceFishing</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.0/dist/tonconnect-ui.min.js"></script>

  <style>
    :root{
      --leaf1:#e6e8ec;
      --leaf2:#3d647f;
      --red:#e11d48;
      --orange:#fb923c;
      --blue:#0b2a8f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 25% 15%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 70% 35%, rgba(255,255,255,.15), rgba(255,255,255,0) 65%),
        url("bg.png") center/cover no-repeat fixed;
    }

    /* snow */
    .snow{pointer-events:none; position:fixed; inset:0; z-index:2; overflow:hidden;}
    .snow span{
      position:absolute; top:-10vh;
      width:6px; height:6px;
      background:rgba(255,255,255,.85);
      border-radius:50%;
      opacity:.85;
      animation: fall linear infinite;
    }
    @keyframes fall{ from{transform:translateY(-10vh)} to{transform:translateY(110vh)} }

    /* confetti */
    .confettiLayer{position:fixed; inset:0; pointer-events:none; z-index:50; overflow:hidden;}
    .confettiPiece{
      position:absolute; top:-12vh;
      width:10px; height:16px;
      border-radius:2px;
      opacity:.95;
      transform: translate3d(0,0,0) rotate(0deg);
      animation-name: confettiFall;
      animation-timing-function: cubic-bezier(.14,.84,.25,1);
      animation-fill-mode: forwards;
    }
    @keyframes confettiFall{
      0%   { transform: translate3d(0,-15vh,0) rotate(0deg); }
      100% { transform: translate3d(var(--dx, 0px), 115vh, 0) rotate(var(--rot, 720deg)); }
    }

    /* HUD */
    .leftHUD{
      position:fixed; left:12px; top:14px;
      display:flex; align-items:center; gap:10px;
      z-index:6; user-select:none; pointer-events:none;
    }
    .cube{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(180,225,255,.75));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      position:relative;
    }
    .cube:after{
      content:""; position:absolute;
      inset:7px 8px 12px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.65); opacity:.9;
    }
    .hudText{
      font-weight:950; letter-spacing:.6px; color:#0b1220; line-height:1;
      min-width:120px; text-transform:uppercase;
      text-shadow: 0 6px 18px rgba(0,0,0,.12);
    }

    /* top right */
    .hudRight{
      position:fixed; right:12px; top:14px; z-index:6;
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      font-weight:950;
      color:#0b1220;
      min-width:120px;
      justify-content:center;
    }
    .pill img{ width:18px; height:18px; border-radius:6px; }
    .pill small{ font-weight:900; opacity:.75; margin-left:4px; }

    .tonBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer; user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none; color:#0b1220;
      font-weight:950;
    }
    .tonBtn img{ width:22px; height:22px; border-radius:6px; }
    .tonBtn:active{ transform: translateY(1px); }

    /* wheel */
    .wheelWrap{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width:min(430px, 92vw);
      height:min(430px, 92vw);
      z-index:3;
      filter: drop-shadow(0 26px 44px rgba(0,0,0,.30));
    }
    canvas{ width:100%; height:100%; border-radius:50%; display:block; }

    /* pointer: red rod */
    .pointer{
      position:absolute;
      left:50%;
      top:-10px;
      transform: translateX(-50%);
      width:90px;
      height:56px;
      pointer-events:none;
      z-index:10;
      filter: drop-shadow(0 12px 12px rgba(0,0,0,.22));
    }
    .pointerRod{
      position:absolute;
      left:50%;
      top:10px;
      width:7px;
      height:44px;
      transform: translateX(-50%) rotate(0deg) skewX(0deg) scaleY(1);
      transform-origin: 50% 0%;
      border-radius:999px;
      background: linear-gradient(180deg, #ff4d4d, #c81d25);
      border:1px solid rgba(0,0,0,.18);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.16);
    }

    /* bottom UI */
    .bottomUI{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(430px, 92vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:4;
    }
    .historyBar{
      width:100%;
      display:flex; gap:6px;
      justify-content:center; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .chip{
      width:16px; height:16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      flex:0 0 auto;
      position:relative;
    }
    .chip::after{
      content:"";
      position:absolute; inset:4px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      opacity:.55;
    }
    .chip.fish::before, .chip.leaf::before{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      content:"";
    }
    .chip.fish::before{ content:"üêü"; }
    .chip.leaf::before{ content:"üçÉ"; }

    .bonusPanel{ width:100%; display:flex; flex-direction:column; gap:10px; }
    .bonusTop, .bonusBottom{ display:flex; gap:8px; justify-content:space-between; }

    .btn{
      position:relative;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      border-radius:16px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ height:42px; flex:1 1 0; font-size:13px; }
    .btn.big{
      height:58px; flex:1 1 0; font-size:12px;
      text-transform:uppercase; letter-spacing:.4px;
      text-align:center; padding:0 10px;
    }
    .btnIcon{
      width:26px; height:26px;
      border-radius:999px;
      background: rgba(255,255,255,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      border:1px solid rgba(0,0,0,.10);
    }
    .c-leaf1{ background: color-mix(in srgb, var(--leaf1) 86%, white 14%); color:#0b1220; }
    .c-leaf2{ background: color-mix(in srgb, var(--leaf2) 86%, white 14%); color:#fff; }
    .c-blue { background: color-mix(in srgb, var(--blue) 74%, white 26%); color:#fff; }
    .c-orange{ background: color-mix(in srgb, var(--orange) 74%, white 26%); color:#1b1b1b; }
    .c-red { background: color-mix(in srgb, var(--red) 74%, white 26%); color:#fff; }

    .placedBet{
      position:absolute;
      right:8px;
      top:8px;
      min-width:34px;
      height:28px;
      padding:0 8px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:950;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      background: rgba(255,255,255,.75);
      color:#0b1220;
    }

    .betRow{ display:flex; justify-content:center; align-items:center; gap:10px; }
    .undoBtn{
      width:44px; height:44px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:not-allowed; user-select:none;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; color:#0b1220;
      -webkit-tap-highlight-color: transparent;
      opacity:.55;
    }

    .betSelect{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      font-weight:950;
      color:#0b1220;
      -webkit-tap-highlight-color: transparent;
    }
    .betHint{ font-size:11px; font-weight:900; opacity:.75; }
    .chev{ opacity:.75; font-weight:950; }
    .betMenu{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:56px;
      min-width:240px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.82);
      box-shadow: 0 18px 34px rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
      display:none;
      z-index:10;
    }
    .betMenu.open{ display:block; }
    .betOptions{ display:flex; gap:8px; justify-content:center; }
    .betChip{
      width:46px; height:46px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
    }
    .c01{ background:#7c3aed; color:#fff; }
    .c02{ background:#22c55e; color:#0b1220; }
    .c05{ background:#f59e0b; color:#1b1b1b; }
    .c10{ background:#ef4444; color:#fff; }

    /* modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:20;
    }
    .modalOverlay.open{ display:flex; }
    .sheet{
      width:min(520px, 96vw);
      border-radius:22px 22px 0 0;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 -18px 40px rgba(0,0,0,.28);
      padding:14px;
      padding-bottom:18px;
    }
    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:6px 6px 12px 6px;
    }
    .sheetTitle{
      font-weight:950; color:#0b1220; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .sheetTitle img{ width:22px; height:22px; border-radius:6px; }
    .closeBtn{
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:950;
    }
    .sheetBtns{ display:flex; flex-direction:column; gap:10px; padding:0 6px; }
    .sheetAction{
      height:54px; border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(245,250,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      cursor:pointer; user-select:none;
      font-weight:950; color:#0b1220;
    }
    .depositInput{
      width:100%; height:52px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      padding:0 14px;
      font-size:18px; font-weight:900;
      outline:none;
    }
    .row2{ display:flex; gap:10px; margin-top:12px; }
    .row2 .sheetAction{ flex:1 1 0; justify-content:center; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>
  <div class="confettiLayer" id="confetti"></div>

  <div class="hudRight">
    <div class="pill" title="–ë–∞–ª–∞–Ω—Å">
      <img src="ton.png" alt="TON" />
      <span id="balanceValue">0</span><small>TON</small>
    </div>
    <a class="tonBtn" href="javascript:void(0)" id="tonConnectBtn">
      <img src="ton.png" alt="TON" />
      <span id="tonBtnText">TON connect</span>
    </a>
  </div>

  <div class="leftHUD">
    <div class="cube"></div>
    <div class="hudText">
      <span id="hudMain">0</span>
    </div>
  </div>

  <div class="wheelWrap">
    <canvas id="wheel" width="900" height="900"></canvas>
    <div class="pointer" aria-hidden="true"><div class="pointerRod" id="pointerRod"></div></div>
  </div>

  <div class="bottomUI">
    <div class="historyBar" id="historyBar"></div>

    <div class="bonusPanel">
      <div class="bonusTop">
        <div class="btn small c-leaf1 bettable" data-target="leaf1"><span class="btnIcon">üçÉ</span> Leaf 1</div>
        <div class="btn small c-leaf2 bettable" data-target="leaf2"><span class="btnIcon">üçÉ</span> Leaf 2</div>
      </div>

      <div class="bonusBottom">
        <div class="btn big c-blue bettable" data-target="lilblues"><span class="btnIcon">üêü</span> LIL BLUES Bonus</div>
        <div class="btn big c-orange bettable" data-target="bigoranges"><span class="btnIcon">üêü</span> BIG ORANGES Bonus</div>
        <div class="btn big c-red bettable" data-target="hugered"><span class="btnIcon">üêü</span> HUGE REDS Bonus</div>
      </div>

      <div class="betRow">
        <button class="undoBtn" id="undoBtn" title="Undo disabled">‚Ü©</button>

        <div class="betSelect" id="betSelect">
          <span id="betValue">0.2</span>
          <span class="betHint">tap to change</span>
          <span class="chev">‚ñæ</span>

          <div class="betMenu" id="betMenu">
            <div class="betOptions">
              <div class="betChip c01" data-bet="0.1">0.1</div>
              <div class="betChip c02" data-bet="0.2">0.2</div>
              <div class="betChip c05" data-bet="0.5">0.5</div>
              <div class="betChip c10" data-bet="1">1</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- TON SHEET -->
  <div class="modalOverlay" id="tonModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle"><img src="ton.png" alt="TON">TON</div>
        <button class="closeBtn" id="tonClose">‚úï</button>
      </div>

      <div class="sheetBtns">
        <div class="sheetAction" id="actionBind"><span>–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</span><small id="walletStatus">Not connected</small></div>
        <div class="sheetAction" id="actionDisconnect"><span>–û—Ç–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</span><small>Disconnect</small></div>
        <div class="sheetAction" id="actionDeposit"><span>–î–µ–ø–æ–∑–∏—Ç</span><small>Enter amount</small></div>
        <div class="sheetAction" id="actionWithdraw"><span>–í—ã–≤–æ–¥</span><small>Later</small></div>
      </div>
    </div>
  </div>

  <!-- DEPOSIT INPUT -->
  <div class="modalOverlay" id="depositModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
        <button class="closeBtn" id="depositClose">‚úï</button>
      </div>

      <input id="depositAmount" class="depositInput" type="number" min="0.1" step="0.1" placeholder="–°–∫–æ–ª—å–∫–æ TON –ø–æ–ø–æ–ª–Ω–∏—Ç—å?">

      <div class="row2">
        <div class="sheetAction" id="depositBack">–ù–∞–∑–∞–¥</div>
        <div class="sheetAction" id="depositConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</div>
      </div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  function showPopup(title, message){
    if (tg?.showPopup) tg.showPopup({ title, message, buttons:[{type:"ok"}] });
    else alert(`${title}\n\n${message}`);
  }

  /* snow */
  (function initSnow(){
    const box = document.getElementById("snow");
    const flakes = 26;
    for (let i=0;i<flakes;i++){
      const s = document.createElement("span");
      const size = 2 + Math.random()*4;
      s.style.width = size + "px";
      s.style.height = size + "px";
      s.style.left = (Math.random()*100) + "vw";
      s.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
      const dur = 6 + Math.random()*8;
      const delay = Math.random()*-dur;
      s.style.animationDuration = dur + "s";
      s.style.animationDelay = delay + "s";
      box.appendChild(s);
    }
  })();

  /* confetti */
  const confettiLayer = document.getElementById("confetti");
  function burstConfetti(colors){
    const count = 90;
    const W = window.innerWidth || 360;
    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      p.className = "confettiPiece";
      p.style.left = (Math.random() * 100) + "vw";
      p.style.width = (6 + Math.random()*10) + "px";
      p.style.height = (8 + Math.random()*14) + "px";
      p.style.background = colors[(Math.random()*colors.length)|0];
      const dx = (Math.random() - 0.5) * Math.min(420, W*0.8);
      const rot = (360 + Math.random()*1080) * (Math.random() < 0.5 ? -1 : 1);
      const dur = 1200 + Math.random()*1500;
      p.style.setProperty("--dx", dx + "px");
      p.style.setProperty("--rot", rot + "deg");
      p.style.animationDuration = dur + "ms";
      p.style.animationDelay = (Math.random()*120) + "ms";
      confettiLayer.appendChild(p);
      setTimeout(() => p.remove(), dur + 250);
    }
  }
  function celebrateFish(kind){
    if (kind === "lilblues") burstConfetti(["#60a5fa","#93c5fd","#dbeafe","#ffffff"]);
    else if (kind === "bigoranges") burstConfetti(["#fb923c","#fdba74","#ffedd5","#ffffff"]);
    else if (kind === "hugered") burstConfetti(["#fb7185","#fecdd3","#ffe4e6","#ffffff"]);
    else burstConfetti(["#ffffff","#dbeafe","#ffedd5","#ffe4e6"]);
  }

  /* ===========================
     FISHING OVERLAY (2D)
     =========================== */
  const fishingOverlay = document.getElementById("fishingOverlay");
  const fishImg = document.getElementById("testFish");
  const fishMultEl = document.getElementById("fishMult");

  const FISH_SRC = {
    lilblues:   "assets/fishing/fish_blue.png",
    bigoranges: "assets/fishing/fish_orange.png",
    hugered:    "assets/fishing/fish_red.png",
  };
  const FISH_MULT = { lilblues:2, bigoranges:5, hugered:10 };

  let fishingBusy = false;

  function playFishingScene(kind){
    if (fishingBusy) return;
    if (!fishingOverlay || !fishImg) return;

    const src = FISH_SRC[kind];
    if (!src) return;

    fishingBusy = true;

    fishImg.src = src;

    if (fishMultEl){
      const m = FISH_MULT[kind] || 1;
      fishMultEl.textContent = "x" + m;
      fishMultEl.style.opacity = "0";
      fishMultEl.style.transform = "translate(-50%,-50%) scale(0.7)";
    }

    fishingOverlay.style.display = "block";
    fishingOverlay.style.opacity = "0";
    fishingOverlay.style.transition = "opacity 550ms ease";
    fishImg.style.opacity = "0";
    fishImg.style.transform = "translate(-50%,-50%) scale(0.35) rotate(-18deg)";
    fishImg.style.transition = "transform 950ms cubic-bezier(.15,.9,.25,1), opacity 250ms ease";

    requestAnimationFrame(()=>{
      fishingOverlay.style.opacity = "1";
      setTimeout(()=>{
        fishImg.style.opacity = "1";
        fishImg.style.transform = "translate(-50%,-50%) scale(1.0) rotate(8deg)";
      }, 380);

      if (fishMultEl){
        setTimeout(()=>{
          fishMultEl.style.transition = "transform 520ms cubic-bezier(.2,1.25,.25,1), opacity 200ms ease";
          fishMultEl.style.opacity = "1";
          fishMultEl.style.transform = "translate(-50%,-50%) scale(1.05)";
        }, 1100);
      }
    });

    // –ø–æ–∫–∞–∑–∞—Ç—å ~2.3 —Å–µ–∫, –∑–∞—Ç–µ–º —Å–∫—Ä—ã—Ç—å
    setTimeout(()=>{
      fishingOverlay.style.opacity = "0";
      setTimeout(()=>{
        fishingOverlay.style.display = "none";
        fishingBusy = false;
      }, 650);
    }, 2300);
  }

  /* ton core helpers */
  let __tonCore = null;
  async function tonCore(){
    if (!__tonCore) __tonCore = await import("https://esm.sh/@ton/core@0.58.0");
    return __tonCore;
  }
  async function toRaw(addr){
    const a = String(addr || "").trim();
    if (!a) return null;
    const { Address } = await tonCore();
    return Address.parse(a).toRawString();
  }
  async function toFriendly(addr){
    const a = String(addr || "").trim();
    if (!a) return null;
    const { Address } = await tonCore();
    return Address.parse(a).toString({ urlSafe: true, bounceable: false, testOnly: false });
  }
  function bytesToBase64(bytes){
    let bin = "";
    for (const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin);
  }
  async function commentToBocBase64(comment){
    const { beginCell } = await tonCore();
    const cell = beginCell().storeUint(0, 32).storeStringTail(String(comment || "")).endCell();
    const boc = cell.toBoc({ idx: false });
    return bytesToBase64(boc);
  }
  function shortAddr(a){ return a ? (a.slice(0,6) + "..." + a.slice(-6)) : ""; }

  /* wallet LS */
  function getWalletRawLS(){
    const ls = (localStorage.getItem("walletRaw") || "").trim();
    return ls || null;
  }
  async function setWalletFromTonConnect(wallet){
    const addr = (wallet?.account?.address || "").trim();
    if (!addr){
      localStorage.removeItem("walletRaw");
      localStorage.removeItem("walletFriendly");
      return;
    }
    const raw = await toRaw(addr);
    localStorage.setItem("walletRaw", raw);
    const fr = await toFriendly(raw);
    if (fr) localStorage.setItem("walletFriendly", fr);
  }
  async function getWalletFriendlyLS(){
    const cached = (localStorage.getItem("walletFriendly") || "").trim();
    if (cached) return cached;
    const raw = getWalletRawLS();
    if (!raw) return null;
    const fr = await toFriendly(raw);
    if (fr) localStorage.setItem("walletFriendly", fr);
    return fr;
  }

  /* TonConnect init */
  (function initTonConnect(){
    try{
      const TonConnectUI = window.TON_CONNECT_UI?.TonConnectUI;
      if (!TonConnectUI) { window.__tonUI = null; window.__wallet = null; return; }

      const tonUI = new TonConnectUI({
        manifestUrl: location.origin + "/tonconnect-manifest.json",
        actionsConfiguration: { twaReturnUrl: "https://t.me/ICE_FISHING_ICE_BOT?startapp=1" }
      });
      window.__tonUI = tonUI;
      window.__wallet = null;

      tonUI.onStatusChange(async (wallet) => {
        window.__wallet = wallet || null;
        try{ await setWalletFromTonConnect(wallet); }catch{
          localStorage.removeItem("walletRaw");
          localStorage.removeItem("walletFriendly");
        }
        window.dispatchEvent(new Event("wallet_changed"));
      });

      tonUI.connectionRestored
        .then(() => window.dispatchEvent(new Event("wallet_changed")))
        .catch(() => {});
    }catch{
      window.__tonUI = null;
      window.__wallet = null;
    }
  })();

  async function bindWalletOnServer(){
    const raw = getWalletRawLS();
    if (!raw) return;
    const initData = tg?.initData || "";
    if (!initData) return;
    try{
      await fetch(`/api/bind_wallet?t=${Date.now()}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ initData, walletAddress: raw })
      });
    }catch{}
  }

  /* UI refs */
  const tonModal = document.getElementById("tonModal");
  const depositModal = document.getElementById("depositModal");
  const balanceValue = document.getElementById("balanceValue");
  const tonBtnText = document.getElementById("tonBtnText");
  const walletStatus = document.getElementById("walletStatus");

  document.getElementById("tonConnectBtn").addEventListener("click", () => tonModal.classList.add("open"));
  document.getElementById("tonClose").addEventListener("click", () => tonModal.classList.remove("open"));
  tonModal.addEventListener("click", (e) => { if (e.target === tonModal) tonModal.classList.remove("open"); });

  document.getElementById("depositClose").addEventListener("click", () => depositModal.classList.remove("open"));
  document.getElementById("depositBack").addEventListener("click", () => depositModal.classList.remove("open"));
  depositModal.addEventListener("click", (e) => { if (e.target === depositModal) depositModal.classList.remove("open"); });

  let balanceTonCache = 0;
  function setBalanceTonUI(v){
    balanceTonCache = Number(v) || 0;
    const s = (Math.round(balanceTonCache * 1000) / 1000).toString();
    balanceValue.textContent = s;
  }

  async function syncWalletUI(){
    const raw = getWalletRawLS();
    if (!raw){
      tonBtnText.textContent = "TON connect";
      walletStatus.textContent = "Not connected";
      setBalanceTonUI(0);
      return;
    }
    const friendly = await getWalletFriendlyLS();
    const show = friendly || raw;
    tonBtnText.textContent = shortAddr(show);
    walletStatus.textContent = shortAddr(show);
  }

  async function getAddressRawForApi(){
    const raw = getWalletRawLS();
    if (!raw) return null;
    try{ return await toRaw(raw); }catch{ return raw; }
  }

  async function refreshBalance(){
    const raw = await getAddressRawForApi();
    if (!raw){ setBalanceTonUI(0); return 0; }
    const r = await fetch(`/api/balance?address=${encodeURIComponent(raw)}&t=${Date.now()}`, { cache:"no-store" });
    if (!r.ok) return balanceTonCache;
    const j = await r.json().catch(()=>({}));
    let ton = 0;
    if (typeof j.balanceTon === "number") ton = j.balanceTon;
    else if (typeof j.ton === "number") ton = j.ton;
    else if (typeof j.nano === "number") ton = j.nano / 1e9;
    else if (typeof j.nano === "string" && j.nano) ton = Number(j.nano) / 1e9;
    if (!Number.isFinite(ton)) ton = 0;
    setBalanceTonUI(ton);
    return ton;
  }

  window.addEventListener("wallet_changed", async () => {
    await syncWalletUI();
    await bindWalletOnServer();
    await resumeDepositsSilently();
    await settleBetsIfNeeded();
    await refreshBalance();
  });

  document.getElementById("actionBind").addEventListener("click", async () => {
    if (window.__tonUI?.openModal) { await window.__tonUI.openModal(); return; }
    showPopup("TON", "TonConnect –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∏–ª–∏ manifest –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.");
  });

  document.getElementById("actionDisconnect").addEventListener("click", async () => {
    try{ await window.__tonUI?.disconnect?.(); }catch{}
    localStorage.removeItem("walletRaw");
    localStorage.removeItem("walletFriendly");
    window.__wallet = null;
    await syncWalletUI();
    setBalanceTonUI(0);
    showPopup("TON", "–ö–æ—à–µ–ª—ë–∫ –æ—Ç–≤—è–∑–∞–Ω.");
  });

  document.getElementById("actionDeposit").addEventListener("click", async () => {
    if (!getWalletRawLS()){ showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }
    depositModal.classList.add("open");
  });

  document.getElementById("actionWithdraw").addEventListener("click", () => showPopup("TON", "–í—ã–≤–æ–¥ –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ."));

  async function confirmDepositTry(intentId, addressRaw){
    const url = `/api/confirm_deposit?intentId=${encodeURIComponent(intentId)}&address=${encodeURIComponent(addressRaw)}&t=${Date.now()}`;
    const r = await fetch(url, { cache:"no-store" });
    const j = await r.json().catch(()=>({}));
    return { ok: r.ok, json: j };
  }

  async function resumeDepositsSilently(){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{ await fetch(`/api/deposit_resume?address=${encodeURIComponent(raw)}&t=${Date.now()}`, { cache:"no-store" }); }catch{}
  }

  async function waitAndCreditSilent(intentId){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{ localStorage.setItem("lastDepositIntentId", String(intentId)); }catch{}
    for (let i=0;i<80;i++){
      const { ok, json } = await confirmDepositTry(intentId, raw);
      if (ok && json?.status === "credited"){
        try{ localStorage.removeItem("lastDepositIntentId"); }catch{}
        await refreshBalance();
        setTimeout(refreshBalance, 350);
        showPopup("TON", `–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω: +${json.creditedTon} TON`);
        return;
      }
      await sleep(1500);
    }
  }

  document.getElementById("depositConfirm").addEventListener("click", async () => {
    const raw = await getAddressRawForApi();
    if (!raw){ showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }

    const amountTon = Number(document.getElementById("depositAmount").value);
    if (!amountTon || amountTon <= 0){ showPopup("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TON"); return; }
    if (amountTon < 0.1){ showPopup("–û—à–∏–±–∫–∞", "–ú–∏–Ω–∏–º—É–º 0.1 TON"); return; }
    if (!window.__tonUI?.sendTransaction){ showPopup("TON", "TonConnect UI –Ω–µ –≥–æ—Ç–æ–≤."); return; }

    const r = await fetch(`/api/deposit_intent?t=${Date.now()}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ amountTon, address: raw })
    });
    if (!r.ok){ showPopup("TON", "–°–µ—Ä–≤–µ—Ä –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."); return; }
    const intent = await r.json();

    try{
      await window.__tonUI.sendTransaction({
        validUntil: Math.floor(Date.now()/1000) + 300,
        messages:[{
          address: intent.toAddressFriendly || intent.toAddressRaw || intent.toAddress,
          amount: String(intent.amountNano),
          payload: await commentToBocBase64(intent.comment || "")
        }]
      });

      depositModal.classList.remove("open");
      setTimeout(() => waitAndCreditSilent(intent.intentId), 8000);
    }catch(e){
      console.log(e);
      showPopup("TON", "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∫–æ—à–µ–ª—å–∫–∞.");
    }
  });

  /* Bets UI */
  let currentBet = 0.2;
  const betSelect = document.getElementById("betSelect");
  const betMenu = document.getElementById("betMenu");
  const betValue = document.getElementById("betValue");
  document.getElementById("undoBtn").addEventListener("click", (e)=>{ e.stopPropagation(); });

  const totals = new Map(); // target -> ton
  function fmt(x){
    const s = (Math.round(x*10)/10).toFixed(1);
    return s.endsWith(".0") ? s.slice(0,-2) : s;
  }
  function closeBetMenu(){ betMenu.classList.remove("open"); }
  function toggleBetMenu(){ betMenu.classList.toggle("open"); }

  betSelect.addEventListener("click", (e) => { e.stopPropagation(); toggleBetMenu(); });
  betMenu.querySelectorAll(".betChip").forEach(chip => {
    chip.addEventListener("click", (e) => {
      e.stopPropagation();
      currentBet = Number(chip.dataset.bet);
      betValue.textContent = fmt(currentBet);
      closeBetMenu();
    });
  });
  document.addEventListener("click", () => closeBetMenu());

  function renderTotalOnButton(target){
    const btn = document.querySelector(`.bettable[data-target="${target}"]`);
    if (!btn) return;
    const total = totals.get(target) || 0;
    const old = btn.querySelector(".placedBet");
    if (old) old.remove();
    if (total > 0){
      const badge = document.createElement("div");
      badge.className = "placedBet";
      badge.textContent = fmt(total);
      btn.appendChild(badge);
    }
  }
  function clearAllBetsUI(){
    totals.clear();
    document.querySelectorAll(".bettable").forEach(btn => {
      const badge = btn.querySelector(".placedBet");
      if (badge) badge.remove();
    });
  }

  async function addBet(target, amountTon){
    if (!getWalletRawLS()){ showPopup("–°—Ç–∞–≤–∫–∏", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }
    if (!S?.round?.roundId && S?.round?.roundId !== 0){ showPopup("–°—Ç–∞–≤–∫–∏", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞—É–Ω–¥–∞."); return; }

    const raw = await getAddressRawForApi();
    const roundId = Number(S.round.roundId);
    const amountNano = Math.trunc(Number(amountTon) * 1e9);

    if (balanceTonCache + 1e-9 < amountTon){
      showPopup("–ë–∞–ª–∞–Ω—Å", `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º ${fmt(amountTon)} TON`);
      return;
    }

    const r = await fetch(`/api/bet_place?t=${Date.now()}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ address: raw, roundId, target, amountNano })
    });
    const j = await r.json().catch(()=>({}));
    if (!r.ok){
      if (j?.error === "insufficient") showPopup("–ë–∞–ª–∞–Ω—Å", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.");
      else showPopup("–°—Ç–∞–≤–∫–∏", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å.");
      return;
    }

    if (typeof j.balanceTon === "number") setBalanceTonUI(j.balanceTon);
    else await refreshBalance();

    const prev = totals.get(target) || 0;
    const next = Math.round((prev + amountTon) * 10) / 10;
    totals.set(target, next);
    renderTotalOnButton(target);
  }

  document.querySelectorAll(".bettable").forEach(btn => {
    btn.addEventListener("click", (e) => { e.stopPropagation(); addBet(btn.dataset.target, currentBet); });
  });

  async function settleBetsIfNeeded(){
    const raw = await getAddressRawForApi();
    if (!raw) return;
    try{
      const r = await fetch(`/api/bet_settle?t=${Date.now()}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ address: raw })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok) return;

      if (Array.isArray(j.settled) && j.settled.length) clearAllBetsUI();
      if (j.creditedTonTotal && j.creditedTonTotal > 0) await refreshBalance();
    }catch{}
  }

  /* ========= WHEEL SYNC ========= */
  const N = 53;
  const step = (Math.PI*2)/N;
  const startOffset = -Math.PI/2;

  const IDX_HUGE = 0;
  const IDX_ORANGES = [13, 39];
  const IDX_BLUES   = [7, 20, 33, 46];

  const css = getComputedStyle(document.documentElement);
  const COLORS = {
    red:    css.getPropertyValue('--red').trim(),
    orange: css.getPropertyValue('--orange').trim(),
    blue:   css.getPropertyValue('--blue').trim(),
    leaf1:  css.getPropertyValue('--leaf1').trim(),
    leaf2:  css.getPropertyValue('--leaf2').trim(),
  };

  const sectors = Array.from({length:N}, ()=>null);
  sectors[IDX_HUGE] = { kind:"hugered", label:"HUGE REDS", fill:COLORS.red, text:"#fff", icon:"fish" };
  for (const i of IDX_ORANGES) sectors[i] = { kind:"bigoranges", label:"BIG ORANGES", fill:COLORS.orange, text:"#1b1b1b", icon:"fish" };
  for (const i of IDX_BLUES)   sectors[i] = { kind:"lilblues", label:"LIL BLUES", fill:COLORS.blue, text:"#fff", icon:"fish" };

  let leaf1Left = 23, leaf2Left = 23;
  let toggle = 0;
  for (let i=0;i<N;i++){
    if (sectors[i]) continue;
    const wantLeaf1 = (toggle % 2 === 0);
    if (wantLeaf1 && leaf1Left > 0){
      sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
      leaf1Left--;
    } else if (!wantLeaf1 && leaf2Left > 0){
      sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
      leaf2Left--;
    } else {
      if (leaf1Left > 0){
        sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
        leaf1Left--;
      } else {
        sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
        leaf2Left--;
      }
    }
    toggle++;
  }

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2;

  const outerR = Math.min(W,H)*0.47;
  const innerR = outerR*0.22;

  function normalize(a){
    const t = Math.PI*2;
    return ((a%t)+t)%t;
  }
  function wrapNear(ref, value){
    const t = Math.PI*2;
    let v = value;
    v += Math.round((ref - v)/t)*t;
    return v;
  }

  const pointerWorld = -Math.PI/2;
  function indexAtPointer(angle){
    const rel = normalize(pointerWorld - angle - startOffset);
    return Math.floor(rel / step);
  }

  function drawFishIcon(x,y,scale,fill){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);
    ctx.fillStyle = fill;

    ctx.beginPath();
    ctx.ellipse(0, 0, 14, 9, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(-14, 0);
    ctx.lineTo(-26, -10);
    ctx.lineTo(-26, 10);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.beginPath();
    ctx.arc(8, -2, 2.2, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawLeafIcon(x,y,scale,stroke){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);

    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2.6;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    ctx.beginPath();
    ctx.moveTo(0, 12);
    ctx.quadraticCurveTo(18, 2, 0, -14);
    ctx.quadraticCurveTo(-18, 2, 0, 12);
    ctx.closePath();
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0, 10);
    ctx.lineTo(0, -12);
    ctx.stroke();

    ctx.restore();
  }

  function drawVerticalChars(text, x, y, fill){
    const t = (text || "").replace(/\s+/g," ").trim();
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle = fill;
    ctx.font = "900 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const lineH = 11;
    const maxLen = 10;
    const s = t.slice(0, maxLen);
    const totalH = (s.length-1)*lineH;
    for (let i=0;i<s.length;i++){
      ctx.fillText(s[i], 0, -totalH/2 + i*lineH);
    }
    ctx.restore();
  }

  function drawOrnaments(angle){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);

    const r = outerR*0.93;
    for (let i=0;i<N;i++){
      const a = i*step + startOffset;
      const x = Math.cos(a) * r;
      const y = Math.sin(a) * r;

      ctx.beginPath();
      ctx.fillStyle = "rgba(0,0,0,0.32)";
      ctx.arc(x,y, 3.2, 0, Math.PI*2);
      ctx.fill();

      ctx.beginPath();
      ctx.fillStyle = "rgba(255,255,255,0.35)";
      ctx.arc(x-0.9,y-0.9, 1.8, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawWheel(angle, highlightIdx=null){
    ctx.clearRect(0,0,W,H);

    ctx.save();
    const ice = ctx.createRadialGradient(cx,cy,innerR, cx,cy,outerR*1.05);
    ice.addColorStop(0, "rgba(255,255,255,0.96)");
    ice.addColorStop(0.55, "rgba(222,236,247,0.98)");
    ice.addColorStop(1, "rgba(184,205,224,0.96)");
    ctx.fillStyle = ice;
    ctx.beginPath();
    ctx.arc(cx,cy,outerR*1.05,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    ctx.save();
    const rimGrad = ctx.createRadialGradient(cx,cy,outerR*0.92, cx,cy,outerR*1.06);
    rimGrad.addColorStop(0, "rgba(18,27,47,0.95)");
    rimGrad.addColorStop(1, "rgba(7,10,18,0.98)");
    ctx.strokeStyle = rimGrad;
    ctx.lineWidth = outerR*0.10;
    ctx.beginPath();
    ctx.arc(cx,cy,outerR*1.02,0,Math.PI*2);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);

    for (let i=0;i<N;i++){
      const a0 = i*step + startOffset;
      const a1 = a0 + step;
      const sec = sectors[i];
      const isHi = (highlightIdx===i);

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0, outerR*0.90, a0, a1);
      ctx.closePath();
      ctx.fillStyle = sec.fill;
      ctx.fill();

      if (isHi){
        ctx.fillStyle = "rgba(255,255,255,0.10)";
        ctx.fill();
      }

      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.lineWidth = 1.0;
      ctx.stroke();

      const mid = (a0+a1)/2;
      const iconR = outerR*0.82;

      ctx.save();
      ctx.rotate(mid);
      ctx.translate(iconR, 0);

      if (sec.icon === "fish"){
        drawFishIcon(0, 0, 1.05, "rgba(255,255,255,0.92)");
        ctx.rotate(Math.PI/2);
        drawVerticalChars(sec.label, 0, 92, sec.text);
      } else {
        const stroke = (sec.kind === "leaf1") ? "rgba(17,24,39,0.65)" : "rgba(255,255,255,0.82)";
        drawLeafIcon(0, 0, 0.9, stroke);
      }

      ctx.restore();
    }
    ctx.restore();

    drawOrnaments(angle);
  }

  /* History from server only */
  const historyBar = document.getElementById("historyBar");
  const history = [];
  const HISTORY_MAX = 18;

  function renderHistory(){
    historyBar.innerHTML = "";
    for (const idx of history){
      const sec = sectors[idx];
      const el = document.createElement("div");
      el.className = "chip " + (sec.icon === "fish" ? "fish" : "leaf");
      el.style.background = sec.fill;
      historyBar.appendChild(el);
    }
  }

  /* ---- SERVER TIME (NO WOBBLE + SANITY) ---- */
  let timeOffset = 0;
  let syncedOnce = false;
  let baseServerNow = Date.now();
  let baseLocalNow = Date.now();
  let lastServerNow = 0;

  const OFFSET_SLEW = 0.22;

  function serverTimeNow(){
    const local = Date.now();
    let est = baseServerNow + (local - baseLocalNow) + timeOffset;
    if (syncedOnce){
      if (est < lastServerNow) est = lastServerNow;
      lastServerNow = est;
    }
    return est;
  }

  async function fetchState(){
    const r = await fetch(`/api/state?t=${Date.now()}`, { cache:"no-store" });
    if (!r.ok) throw new Error("api_state_error");
    return await r.json();
  }

  /* ========= SYNCHRONIZED PHASE ========= */
  const SPIN_MS = 8600;
  const POST_DELAY_MS = 15000;
  const SPIN_TURNS = 22;

  function easeOutQuint(t){ return 1 - Math.pow(1-t, 5); }

  function desiredAngleForWinner(winnerIdx){
    const winnerCenter = (winnerIdx + 0.5)*step + startOffset;
    return normalize(pointerWorld - winnerCenter);
  }

  function buildTargetAngleFromStart(startAngle, winnerIdx){
    const desiredMod = desiredAngleForWinner(winnerIdx);
    const base = startAngle - SPIN_TURNS * Math.PI * 2;
    const k = Math.floor((base - desiredMod) / (Math.PI*2));
    return desiredMod + k * (Math.PI*2);
  }

  let renderAngle = 0;
  const ANGLE_SMOOTH = 0.16;

  let S = null;

  let anchorRoundId = null;
  let anchorStartAngle = 0;
  let anchorTargetAngle = 0;
  let anchorWinner = 0;

  let spinStartAt = 0;
  let endAt = 0;
  let nextSpinAt = 0;

  const hudMain = document.getElementById("hudMain");

  // countdown anti-jitter (—Ç–∞–π–º–µ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω "—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è" –∏–∑-–∑–∞ —Ä–µ—Å–∏–Ω–∫–∞)
  let lastShownCountdown = null;
  let lastCountdownRoundId = null;

  const pointerRod = document.getElementById("pointerRod");
  let lastRAFTime = 0;
  let lastRAFAngle = 0;
  let flex = 0;

  function updatePointerFlex(now){
    if (!lastRAFTime){
      lastRAFTime = now;
      lastRAFAngle = renderAngle;
      return;
    }
    const dt = Math.max(1, now - lastRAFTime);
    const da = renderAngle - lastRAFAngle;
    const omega = Math.abs(da) / dt;

    const target = Math.min(1, omega * 115);
    flex += (target - flex) * 0.18;

    const rot = -(flex * 9);
    const skew = -(flex * 7);
    const squash = 1 - flex * 0.07;

    pointerRod.style.transform = `translateX(-50%) rotate(${rot}deg) skewX(${skew}deg) scaleY(${squash})`;

    lastRAFTime = now;
    lastRAFAngle = renderAngle;
  }

  function applyState(state){
    S = state;

    // time sync
    const targetOffset = (state.serverNow || Date.now()) - Date.now();

    if (!syncedOnce){
      syncedOnce = true;
      timeOffset = targetOffset;
      baseServerNow = state.serverNow || Date.now();
      baseLocalNow = Date.now();
      lastServerNow = baseServerNow + timeOffset;
    } else {
      timeOffset = timeOffset + (targetOffset - timeOffset) * OFFSET_SLEW;
    }

    const srvSpin = Number(state.spinMs || SPIN_MS);
    const srvDelay = Number(state.postDelayMs || POST_DELAY_MS);

    const listAll = (state.history || []).slice().sort((a,b)=>a.roundId-b.roundId);
    history.length = 0;
    for (const item of listAll.slice(-HISTORY_MAX)) history.push(item.winnerIndex);
    renderHistory();

    const rid = Number(state.round?.roundId);
    const winner = Number(state.round?.winnerIndex);

    const sStart = Number(state.round?.startAt);
    const sEnd = Number(state.round?.endAt);
    const sNext = Number(state.round?.nextAt);

    if (!Number.isFinite(rid) || !Number.isFinite(winner) || !Number.isFinite(sStart) || !Number.isFinite(sEnd) || !Number.isFinite(sNext)) {
      return;
    }

    const maxSpin = Math.max(4000, Math.min(12000, srvSpin));
    const maxDelay = Math.max(5000, Math.min(60000, srvDelay));

    spinStartAt = sStart;
    endAt = sEnd;

    if ((endAt - spinStartAt) < 1000 || (endAt - spinStartAt) > 30000){
      endAt = spinStartAt + maxSpin;
    }

    // ‚úÖ –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: nextAt —Å —Å–µ—Ä–≤–µ—Ä–∞ (—É –≤—Å–µ—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–∞–π–º–µ—Ä)
    nextSpinAt = sNext;

    // fallback –µ—Å–ª–∏ nextAt –±–∏—Ç—ã–π (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
    if (!Number.isFinite(nextSpinAt) || nextSpinAt <= endAt) nextSpinAt = endAt + maxDelay;

    if (anchorRoundId !== rid || anchorWinner !== winner || anchorRoundId === null){
      anchorRoundId = rid;
      anchorWinner = winner;

      let prevWinnerIdx = null;
      if (listAll.length >= 1) prevWinnerIdx = listAll[listAll.length - 1].winnerIndex;

      const desiredStart = (typeof prevWinnerIdx === "number")
        ? desiredAngleForWinner(prevWinnerIdx)
        : renderAngle;

      anchorStartAngle = wrapNear(renderAngle, desiredStart);

      const rawTarget = buildTargetAngleFromStart(anchorStartAngle, winner);
      anchorTargetAngle = wrapNear(anchorStartAngle - (SPIN_TURNS * Math.PI*2), rawTarget);
    }
  }

  function setHUD(){
    if (!S){ hudMain.textContent = "0"; return; }

    const now = serverTimeNow();

    // –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ -> —Å–±—Ä–æ—Å –∞–Ω—Ç–∏-–¥–∂–∏—Ç—Ç–µ—Ä–∞
    if (lastCountdownRoundId !== anchorRoundId){
      lastCountdownRoundId = anchorRoundId;
      lastShownCountdown = null;
    }

    if (now >= spinStartAt && now <= endAt){
      hudMain.textContent = ""; // –≤–æ –≤—Ä–µ–º—è —Å–ø–∏–Ω–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      lastShownCountdown = null;
      return;
    }

    if (now > endAt && now < nextSpinAt){
      let left = Math.max(0, Math.ceil((nextSpinAt - now)/1000));

      // –∑–∞–ø—Ä–µ—â–∞–µ–º —Ç–∞–π–º–µ—Ä—É –ø—Ä—ã–≥–∞—Ç—å –≤–≤–µ—Ä—Ö (12 -> 13 -> 12)
      if (lastShownCountdown === null) lastShownCountdown = left;
      else left = Math.min(lastShownCountdown, left);

      lastShownCountdown = left;
      hudMain.textContent = String(left);
      return;
    }

    if (now < spinStartAt){
      let left = Math.max(0, Math.ceil((spinStartAt - now)/1000));

      if (lastShownCountdown === null) lastShownCountdown = left;
      else left = Math.min(lastShownCountdown, left);

      lastShownCountdown = left;
      hudMain.textContent = String(left);
      return;
    }

    hudMain.textContent = "0";
  }

  function computeTrueAngle(now){
    if (!S) return renderAngle;
    if (now < spinStartAt) return anchorStartAngle;
    if (now >= endAt) return anchorTargetAngle;

    const t = (now - spinStartAt) / (endAt - spinStartAt);
    const k = easeOutQuint(Math.min(1, Math.max(0, t)));
    return anchorStartAngle + (anchorTargetAngle - anchorStartAngle) * k;
  }

  let celebratedRoundId = null;
  let settledRoundId = null;

  function maybeEndOfSpinActions(now){
    if (!S) return;
    if (now < endAt) return;

    if (celebratedRoundId !== anchorRoundId){
      celebratedRoundId = anchorRoundId;

      // ‚úÖ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–±/–ª–∏—Å—Ç—å—è –ø–æ sectors[winner].kind (–∞ –Ω–µ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º)
      const sec = sectors[anchorWinner];
      const kind = sec?.kind || "leaf";
      const isLeaf = (kind === "leaf" || kind === "leaf1" || kind === "leaf2");

      if (!isLeaf){
        celebrateFish(kind);
        playFishingScene(kind);
      }
    }

    if (settledRoundId !== anchorRoundId){
      settledRoundId = anchorRoundId;
      setTimeout(settleBetsIfNeeded, 200);
      setTimeout(refreshBalance, 600);
    }
  }

  function raf(now){
    const sn = serverTimeNow();
    const trueAngle = computeTrueAngle(sn);

    const diff = Math.abs(trueAngle - renderAngle);
    if (diff > Math.PI * 1.5) {
      // –±–æ–ª—å—à–æ–π —Å–∫–∞—á–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è) ‚Äî —Å—Ç–∞–≤–∏–º —Å—Ä–∞–∑—É
      renderAngle = trueAngle;
    } else {
      renderAngle = renderAngle + (trueAngle - renderAngle) * ANGLE_SMOOTH;
    }

    const hi = indexAtPointer(renderAngle);
    drawWheel(renderAngle, hi);
    updatePointerFlex(now);
    setHUD();
    maybeEndOfSpinActions(sn);

    requestAnimationFrame(raf);
  }

  async function syncLoop(){
    try{
      const st = await fetchState();
      applyState(st);
    }catch{}
  }

  /* init */
  (async function initAll(){
    await syncWalletUI();
    if (getWalletRawLS()) await bindWalletOnServer();
    await refreshBalance();

    await resumeDepositsSilently();

    const lastIntent = (localStorage.getItem("lastDepositIntentId") || "").trim();
    if (lastIntent && getWalletRawLS()){
      const raw = await getAddressRawForApi();
      if (raw) confirmDepositTry(lastIntent, raw).catch(()=>{});
    }

    await settleBetsIfNeeded();

    drawWheel(renderAngle, null);
    renderHistory();

    await syncLoop();

    setInterval(syncLoop, 1100);
    setInterval(refreshBalance, 5000);
    setInterval(resumeDepositsSilently, 12000);
    setInterval(settleBetsIfNeeded, 6500);

    requestAnimationFrame(raf);
  })();
</script>

<!-- FISHING SCENE OVERLAY -->
<div id="fishingOverlay" style="
  position:fixed;
  inset:0;
  background:url('assets/fishing/bg_lake.jpg') center/cover no-repeat;
  z-index:9999;
  display:none;
">
  <div style="position:absolute; inset:0; background:rgba(0,0,0,0.10)"></div>

  <img id="testFish"
       src="assets/fishing/fish_blue.png"
       style="
         position:absolute;
         left:58%;
         top:62%;
         transform:translate(-50%,-50%);
         width:200px;
         height:auto;
         filter: drop-shadow(0 18px 35px rgba(0,0,0,0.55));
       ">

  <div id="fishMult" style="
    position:absolute;
    left:58%;
    top:62%;
    transform:translate(-50%,-50%);
    font-size:56px;
    font-weight:1000;
    color:#fff;
    text-shadow: 0 4px 0 rgba(0,0,0,.6), 0 14px 30px rgba(0,0,0,.35);
    -webkit-text-stroke: 3px rgba(0,0,0,.35);
    opacity:0;
    pointer-events:none;
  ">x2</div>
</div>

</body>
</html>
