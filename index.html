<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IceFishing Wheel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      /* Leaf —Ü–≤–µ—Ç–∞ */
      --leaf1:#e6e8ec;   /* –ø–æ—á—Ç–∏ –±–µ–ª—ã–π, —Å–µ—Ä–æ–≤–∞—Ç—ã–π */
      --leaf2:#3f5f78;   /* ‚úÖ —Ç–µ–º–Ω—ã–π, –Ω–æ —Å–≤–µ—Ç–ª–µ–µ –∏ –±–æ–ª–µ–µ –≥–æ–ª—É–±–æ–π */

      --red:#e11d48;
      --orange:#fb923c;
      --blue:#0b2a8f;

      --ring1:#0b1220;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;

      background:
        radial-gradient(900px 600px at 25% 15%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 70% 35%, rgba(255,255,255,.18), rgba(255,255,255,0) 65%),
        url("bg.png") center/cover no-repeat fixed;
    }

    /* —Å–Ω–µ–≥ */
    .snow { pointer-events:none; position:fixed; inset:0; z-index:2; overflow:hidden; }
    .snow span{
      position:absolute; top:-10vh;
      width:6px; height:6px;
      background:rgba(255,255,255,.85);
      border-radius:50%;
      filter: blur(.2px);
      opacity:.85;
      animation: fall linear infinite;
    }
    @keyframes fall{ from { transform: translateY(-10vh);} to { transform: translateY(110vh);} }

    /* HUD */
    .leftHUD{
      position:fixed; left:12px; top:14px;
      display:flex; align-items:center; gap:10px;
      z-index:6; user-select:none; pointer-events:none;
    }
    .cube{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(180,225,255,.75));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      position:relative;
    }
    .cube:after{
      content:""; position:absolute;
      inset:7px 8px 12px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.65); opacity:.9;
    }
    .hudText{
      font-weight:950; letter-spacing:.6px; color:#0b1220; line-height:1;
      min-width:160px; text-transform:uppercase;
      text-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .hudText small{
      display:block; font-weight:900; opacity:.75;
      letter-spacing:.2px; margin-top:3px; font-size:11px;
    }

    /* TON */
    .tonBtn{
      position:fixed; right:12px; top:14px; z-index:6;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer; user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none; color:#0b1220;
      font-weight:950; letter-spacing:.2px;
    }
    .tonBtn img{ width:22px; height:22px; display:block; border-radius:6px; }
    .tonBtn:active{ transform: translateY(1px); }

    /* ‚úÖ –∫–æ–ª–µ—Å–æ —Ç–µ–ø–µ—Ä—å FIXED –ø–æ —Ü–µ–Ω—Ç—Ä—É, –Ω–∏–∂–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –µ–≥–æ –Ω–µ –¥–≤–∏–≥–∞—é—Ç */
    .wheelWrap{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width:min(430px, 92vw);
      height:min(430px, 92vw);
      z-index:3;
      filter: drop-shadow(0 26px 44px rgba(0,0,0,.30));
    }
    canvas{ width:100%; height:100%; border-radius:50%; }

    /* —É–∫–∞–∑–∞—Ç–µ–ª—å */
    .pointer{
      position:absolute; top:-8px; left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:30px solid var(--ring1);
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));
      pointer-events:none;
    }
    .pointer:after{
      content:""; position:absolute; left:-10px; top:-28px;
      width:0;height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-top:18px solid rgba(255,255,255,.92);
      opacity:.9;
    }

    /* ‚úÖ –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω —Å–Ω–∏–∑—É */
    .bottomUI{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(430px, 92vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:4;
    }

    /* –∏—Å—Ç–æ—Ä–∏—è */
    .historyBar{
      width:100%;
      display:flex; gap:6px;
      justify-content:center; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .chip{
      width:16px; height:16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      flex:0 0 auto;
      position:relative;
    }
    .chip::after{
      content:"";
      position:absolute; inset:4px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      opacity:.55;
    }
    .chip.fish::before, .chip.leaf::before{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      content:"";
    }
    .chip.fish::before{ content:"üêü"; }
    .chip.leaf::before{ content:"üçÉ"; }

    /* –∫–Ω–æ–ø–∫–∏ */
    .bonusPanel{ width:100%; display:flex; flex-direction:column; gap:10px; }
    .bonusTop, .bonusBottom{ display:flex; gap:8px; justify-content:space-between; }

    .btn{
      position:relative;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      border-radius:16px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ height:42px; flex:1 1 0; font-size:13px; }
    .btn.big{
      height:58px; flex:1 1 0; font-size:12px;
      text-transform:uppercase; letter-spacing:.4px;
      text-align:center; padding:0 10px;
    }
    .btnIcon{
      width:26px; height:26px;
      border-radius:999px;
      background: rgba(255,255,255,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      border:1px solid rgba(0,0,0,.10);
    }

    /* –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ */
    .c-leaf1{ background: color-mix(in srgb, var(--leaf1) 86%, white 14%); color:#0b1220; }
    .c-leaf2{ background: color-mix(in srgb, var(--leaf2) 86%, white 14%); color:#fff; }

    .c-blue { background: color-mix(in srgb, var(--blue) 74%, white 26%); color:#fff; }
    .c-orange{ background: color-mix(in srgb, var(--orange) 74%, white 26%); color:#1b1b1b; }
    .c-red { background: color-mix(in srgb, var(--red) 74%, white 26%); color:#fff; }

    /* —Å—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ */
    .placedBet{
      position:absolute;
      right:8px;
      top:8px;
      min-width:34px;
      height:28px;
      padding:0 8px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:950;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      background: rgba(255,255,255,.75);
      color:#0b1220;
    }

    /* –ø–∞–Ω–µ–ª—å —Ñ–∏—à–µ–∫ + undo */
    .betRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:0;
    }
    .undoBtn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      color:#0b1220;
      -webkit-tap-highlight-color: transparent;
    }
    .undoBtn:active{ transform: translateY(1px); }
    .undoBtn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .betSelect{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      font-weight:950;
      color:#0b1220;
      -webkit-tap-highlight-color: transparent;
    }
    .betHint{
      font-size:11px;
      font-weight:900;
      opacity:.75;
      letter-spacing:.2px;
      margin-left:2px;
    }
    .chev{ opacity:.75; font-weight:950; margin-left:6px; }

    .betMenu{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:54px;
      min-width:240px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.82);
      box-shadow: 0 18px 34px rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
      display:none;
      z-index:10;
    }
    .betMenu.open{ display:block; }
    .betOptions{ display:flex; gap:8px; justify-content:center; }
    .betChip{
      width:46px; height:46px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
    }
    .betChip:active{ transform: translateY(1px); }
    .c01{ background:#7c3aed; color:#fff; }
    .c02{ background:#22c55e; color:#0b1220; }
    .c05{ background:#f59e0b; color:#1b1b1b; }
    .c10{ background:#ef4444; color:#fff; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <a class="tonBtn" href="javascript:void(0)" id="tonConnectBtn">
    <img src="ton.png" alt="TON" />
    TON connect
  </a>

  <div class="leftHUD">
    <div class="cube"></div>
    <div class="hudText">
      <span id="hudMain">6</span>
      <small id="hudSub">–¥–æ —Å–ø–∏–Ω–∞</small>
    </div>
  </div>

  <!-- ‚úÖ –∫–æ–ª–µ—Å–æ –≤—Å–µ–≥–¥–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
  <div class="wheelWrap">
    <div class="pointer"></div>
    <canvas id="wheel" width="900" height="900"></canvas>
  </div>

  <!-- ‚úÖ UI –∑–∞–∫—Ä–µ–ø–ª–µ–Ω —Å–Ω–∏–∑—É -->
  <div class="bottomUI">
    <div class="historyBar" id="historyBar"></div>

    <div class="bonusPanel">
      <div class="bonusTop">
        <div class="btn small c-leaf1 bettable" data-target="leaf1">
          <span class="btnIcon">üçÉ</span>
          Leaf 1
        </div>
        <div class="btn small c-leaf2 bettable" data-target="leaf2">
          <span class="btnIcon">üçÉ</span>
          Leaf 2
        </div>
      </div>

      <div class="bonusBottom">
        <div class="btn big c-blue bettable" data-target="lilblues">
          <span class="btnIcon">üêü</span>
          Lil Blues Bonus
        </div>
        <div class="btn big c-orange bettable" data-target="bigoranges">
          <span class="btnIcon">üêü</span>
          Big Oranges Bonus
        </div>
        <div class="btn big c-red bettable" data-target="hugered">
          <span class="btnIcon">üêü</span>
          Huge Reds Bonus
        </div>
      </div>

      <div class="betRow">
        <button class="undoBtn" id="undoBtn" title="Undo last bet" disabled>‚Ü©</button>

        <div class="betSelect" id="betSelect">
          <span id="betValue">0.2</span>
          <span class="betHint">tap to change</span>
          <span class="chev">‚ñæ</span>

          <div class="betMenu" id="betMenu">
            <div class="betOptions">
              <div class="betChip c01" data-bet="0.1">0.1</div>
              <div class="betChip c02" data-bet="0.2">0.2</div>
              <div class="betChip c05" data-bet="0.5">0.5</div>
              <div class="betChip c10" data-bet="1">1</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  // TON (–∑–∞–≥–ª—É—à–∫–∞)
  document.getElementById("tonConnectBtn").addEventListener("click", () => {
    tg?.showPopup?.({ title: "TON", message: "TON Connect —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω.", buttons: [{type:"ok"}] });
  });

  // —Å–Ω–µ–≥
  (function initSnow(){
    const box = document.getElementById("snow");
    const flakes = 26;
    for (let i=0;i<flakes;i++){
      const s = document.createElement("span");
      const size = 2 + Math.random()*4;
      s.style.width = size + "px";
      s.style.height = size + "px";
      s.style.left = (Math.random()*100) + "vw";
      s.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
      s.style.filter = `blur(${(Math.random()*0.9).toFixed(2)}px)`;
      const dur = 6 + Math.random()*8;
      const delay = Math.random()*-dur;
      s.style.animationDuration = dur + "s";
      s.style.animationDelay = delay + "s";
      box.appendChild(s);
    }
  })();

  // --- BETS + UNDO ---
  let currentBet = 0.2;
  const betSelect = document.getElementById("betSelect");
  const betMenu = document.getElementById("betMenu");
  const betValue = document.getElementById("betValue");
  const undoBtn = document.getElementById("undoBtn");

  const totals = new Map();     // target -> total
  const actions = [];           // stack {target, amount}

  function fmt(x){
    const s = (Math.round(x*10)/10).toFixed(1);
    return s.endsWith(".0") ? s.slice(0,-2) : s;
  }
  function updateUndoState(){ undoBtn.disabled = actions.length === 0; }

  function closeBetMenu(){ betMenu.classList.remove("open"); }
  function toggleBetMenu(){ betMenu.classList.toggle("open"); }

  betSelect.addEventListener("click", (e) => { e.stopPropagation(); toggleBetMenu(); });

  betMenu.querySelectorAll(".betChip").forEach(chip => {
    chip.addEventListener("click", (e) => {
      e.stopPropagation();
      currentBet = Number(chip.dataset.bet);
      betValue.textContent = fmt(currentBet);
      closeBetMenu();
    });
  });

  document.addEventListener("click", () => closeBetMenu());

  function renderTotalOnButton(target){
    const btn = document.querySelector(`.bettable[data-target="${target}"]`);
    if (!btn) return;
    const total = totals.get(target) || 0;

    const old = btn.querySelector(".placedBet");
    if (old) old.remove();

    if (total > 0){
      const badge = document.createElement("div");
      badge.className = "placedBet";
      badge.textContent = fmt(total);
      btn.appendChild(badge);
    }
  }

  function addBet(target, amount){
    const prev = totals.get(target) || 0;
    const next = Math.round((prev + amount) * 10) / 10;
    totals.set(target, next);
    actions.push({ target, amount });
    renderTotalOnButton(target);
    updateUndoState();
  }

  function undoLast(){
    if (actions.length === 0) return;
    const last = actions.pop();
    const prev = totals.get(last.target) || 0;
    const next = Math.round((prev - last.amount) * 10) / 10;
    if (next <= 0) totals.delete(last.target);
    else totals.set(last.target, next);
    renderTotalOnButton(last.target);
    updateUndoState();
  }

  undoBtn.addEventListener("click", (e) => { e.stopPropagation(); undoLast(); });

  document.querySelectorAll(".bettable").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      addBet(btn.dataset.target, currentBet);
    });
  });

  // --- WHEEL ---
  const N = 53;
  const step = (Math.PI*2)/N;
  const startOffset = -Math.PI/2;

  const IDX_HUGE = 0;
  const IDX_ORANGES = [13, 39];
  const IDX_BLUES   = [7, 20, 33, 46];

  const css = getComputedStyle(document.documentElement);
  const COLORS = {
    red:    css.getPropertyValue('--red').trim(),
    orange: css.getPropertyValue('--orange').trim(),
    blue:   css.getPropertyValue('--blue').trim(),
    leaf1:  css.getPropertyValue('--leaf1').trim(),
    leaf2:  css.getPropertyValue('--leaf2').trim(),
  };

  const sectors = Array.from({length:N}, ()=>null);
  sectors[IDX_HUGE] = { kind:"huge", label:"HUGE REDS", fill:COLORS.red, text:"#fff", icon:"fish" };
  for (const i of IDX_ORANGES) sectors[i] = { kind:"orange", label:"BIG ORANGES", fill:COLORS.orange, text:"#1b1b1b", icon:"fish" };
  for (const i of IDX_BLUES)   sectors[i] = { kind:"blue", label:"LIL BLUES", fill:COLORS.blue, text:"#fff", icon:"fish" };

  let leaf1Left = 23, leaf2Left = 23;
  let toggle = 0;
  for (let i=0;i<N;i++){
    if (sectors[i]) continue;
    const wantLeaf1 = (toggle % 2 === 0);
    if (wantLeaf1 && leaf1Left > 0){
      sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
      leaf1Left--;
    } else if (!wantLeaf1 && leaf2Left > 0){
      sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
      leaf2Left--;
    } else {
      if (leaf1Left > 0){
        sectors[i] = { kind:"leaf1", label:"", fill:COLORS.leaf1, text:"#111827", icon:"leaf" };
        leaf1Left--;
      } else {
        sectors[i] = { kind:"leaf2", label:"", fill:COLORS.leaf2, text:"#fff", icon:"leaf" };
        leaf2Left--;
      }
    }
    toggle++;
  }

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2;

  const outerR = Math.min(W,H)*0.47;
  const innerR = outerR*0.22;

  let angle = 0;
  let spinning = false;

  function normalize(a){
    const t = Math.PI*2;
    return ((a%t)+t)%t;
  }
  function indexAtPointer(a){
    const pointerWorld = -Math.PI/2;
    const rel = normalize(pointerWorld - a - startOffset);
    return Math.floor(rel / step);
  }
  function rand01(){
    if (window.crypto?.getRandomValues){
      const u = new Uint32Array(1);
      crypto.getRandomValues(u);
      return u[0] / 4294967296;
    }
    return Math.random();
  }

  function drawFishIcon(x,y,scale,fill){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);
    ctx.fillStyle = fill;

    ctx.beginPath();
    ctx.ellipse(0, 0, 14, 9, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(-14, 0);
    ctx.lineTo(-26, -10);
    ctx.lineTo(-26, 10);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.beginPath();
    ctx.arc(8, -2, 2.2, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawLeafIcon(x,y,scale,stroke){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale, scale);

    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2.6;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    ctx.beginPath();
    ctx.moveTo(0, 12);
    ctx.quadraticCurveTo(18, 2, 0, -14);
    ctx.quadraticCurveTo(-18, 2, 0, 12);
    ctx.closePath();
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0, 10);
    ctx.lineTo(0, -12);
    ctx.stroke();

    ctx.restore();
  }

  function drawVerticalChars(text, x, y, fill){
    const t = text.replace(/'/g,"").replace(/\s+/g," ").trim();
    ctx.save();
    ctx.translate(x,y);
    ctx.fillStyle = fill;
    ctx.font = "900 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    const lineH = 11;
    const maxLen = 10;
    const s = t.slice(0, maxLen);
    const totalH = (s.length-1)*lineH;

    for (let i=0;i<s.length;i++){
      ctx.fillText(s[i], 0, -totalH/2 + i*lineH);
    }
    ctx.restore();
  }

  function drawWheel(highlightIdx=null){
    ctx.clearRect(0,0,W,H);

    ctx.save();
    const ice = ctx.createRadialGradient(cx,cy,innerR, cx,cy,outerR*1.05);
    ice.addColorStop(0, "rgba(255,255,255,0.96)");
    ice.addColorStop(0.55, "rgba(222,236,247,0.98)");
    ice.addColorStop(1, "rgba(184,205,224,0.96)");
    ctx.fillStyle = ice;
    ctx.beginPath();
    ctx.arc(cx,cy,outerR*1.05,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    ctx.save();
    const rimGrad = ctx.createRadialGradient(cx,cy,outerR*0.92, cx,cy,outerR*1.06);
    rimGrad.addColorStop(0, "rgba(18,27,47,0.95)");
    rimGrad.addColorStop(1, "rgba(7,10,18,0.98)");
    ctx.strokeStyle = rimGrad;
    ctx.lineWidth = outerR*0.10;
    ctx.beginPath();
    ctx.arc(cx,cy,outerR*1.02,0,Math.PI*2);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);

    for (let i=0;i<N;i++){
      const a0 = i*step + startOffset;
      const a1 = a0 + step;
      const sec = sectors[i];
      const isHi = (highlightIdx===i);

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0, outerR*0.90, a0, a1);
      ctx.closePath();

      ctx.fillStyle = sec.fill;
      ctx.fill();

      if (isHi){
        ctx.fillStyle = "rgba(255,255,255,0.10)";
        ctx.fill();
      }

      ctx.strokeStyle = "rgba(255,255,255,0.20)";
      ctx.lineWidth = 1.1;
      ctx.stroke();

      const mid = (a0+a1)/2;
      const iconR = outerR*0.82;

      ctx.save();
      ctx.rotate(mid);
      ctx.translate(iconR, 0);

      if (sec.icon === "fish"){
        drawFishIcon(0, 0, 1.05, "rgba(255,255,255,0.92)");
        ctx.rotate(Math.PI/2);
        drawVerticalChars(sec.label, 0, 82, sec.text);
      } else {
        const stroke = (sec.kind === "leaf1") ? "rgba(17,24,39,0.65)" : "rgba(255,255,255,0.82)";
        drawLeafIcon(0, 0, 0.9, stroke);
      }

      ctx.restore();
    }

    ctx.restore();

    if (spinning){
      ctx.save();
      ctx.translate(cx,cy);

      ctx.beginPath();
      ctx.arc(0,0, innerR*1.55, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.08)";
      ctx.lineWidth = 10;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(0,0, innerR*1.05, 0, Math.PI*2);
      ctx.fillStyle = "rgba(240,250,255,0.96)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.lineWidth = 6;
      ctx.stroke();

      ctx.fillStyle = "rgba(11,18,32,0.90)";
      ctx.font = `950 ${Math.floor(innerR*0.38)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ICE", 0, -innerR*0.18);
      ctx.fillText("FISHING", 0, innerR*0.20);

      ctx.restore();
    }
  }

  // —Ü–∏–∫–ª: —Ç–∞–π–º–µ—Ä 6 -> —Å–ø–∏–Ω -> —Ñ–∏–∫—Å–∞—Ü–∏—è -> —Ç–∞–π–º–µ—Ä 6
  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  const SPIN_TURNS = 9;
  const SPIN_MS = 4200;

  function pickWinnerIndex(){ return Math.floor(rand01() * N); }

  async function spinOnce(){
    if (spinning) return;
    spinning = true;
    setHUDSpinning(true);

    const winnerIdx = pickWinnerIndex();
    const pointerWorld = -Math.PI/2;
    const winnerCenter = (winnerIdx + 0.5)*step + startOffset;
    const target = (pointerWorld - winnerCenter) - SPIN_TURNS * Math.PI * 2;

    const start = angle;
    const end = target;
    const t0 = performance.now();

    await new Promise(resolve=>{
      function frame(now){
        const t = Math.min(1,(now-t0)/SPIN_MS);
        const k = easeOutCubic(t);
        angle = start + (end-start)*k;
        drawWheel(indexAtPointer(angle));
        if (t<1) requestAnimationFrame(frame);
        else resolve();
      }
      requestAnimationFrame(frame);
    });

    const finalIdx = indexAtPointer(angle);
    addHistory(finalIdx);

    spinning = false;
    setHUDSpinning(false);
    drawWheel(null);
    startCountdown();
  }

  // HUD
  const hudMain = document.getElementById("hudMain");
  const hudSub  = document.getElementById("hudSub");
  let countdownTimer = null;
  let secondsLeft = 6;

  function setHUDSpinning(isSpin){
    if (isSpin){
      hudMain.textContent = "ICE FISHING";
      hudSub.textContent = "spinning";
    } else {
      hudSub.textContent = "–¥–æ —Å–ø–∏–Ω–∞";
      hudMain.textContent = String(secondsLeft);
    }
  }

  function startCountdown(){
    clearInterval(countdownTimer);
    secondsLeft = 6;
    hudMain.textContent = String(secondsLeft);
    hudSub.textContent = "–¥–æ —Å–ø–∏–Ω–∞";

    countdownTimer = setInterval(()=>{
      if (spinning) return;
      secondsLeft -= 1;
      if (secondsLeft <= 0){
        clearInterval(countdownTimer);
        spinOnce();
        return;
      }
      hudMain.textContent = String(secondsLeft);
    }, 1000);
  }

  // –∏—Å—Ç–æ—Ä–∏—è
  const historyBar = document.getElementById("historyBar");
  const history = [];
  const HISTORY_MAX = 18;

  function addHistory(idx){
    history.unshift(idx);
    if (history.length > HISTORY_MAX) history.pop();
    renderHistory();
  }
  function renderHistory(){
    historyBar.innerHTML = "";
    for (const idx of history){
      const sec = sectors[idx];
      const el = document.createElement("div");
      el.className = "chip " + (sec.icon === "fish" ? "fish" : "leaf");
      el.style.background = sec.fill;
      historyBar.appendChild(el);
    }
  }

  // bet menu + undo state init
  updateUndoState();
  drawWheel(null);
  renderHistory();
  startCountdown();

  // ---- bet menu handlers (–ø–æ—Å–ª–µ init, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏) ----
  function closeBetMenu(){ betMenu.classList.remove("open"); }
  function toggleBetMenu(){ betMenu.classList.toggle("open"); }
  betSelect.addEventListener("click", (e) => { e.stopPropagation(); toggleBetMenu(); });
  betMenu.querySelectorAll(".betChip").forEach(chip => {
    chip.addEventListener("click", (e) => {
      e.stopPropagation();
      currentBet = Number(chip.dataset.bet);
      betValue.textContent = fmt(currentBet);
      closeBetMenu();
    });
  });
  document.addEventListener("click", () => closeBetMenu());

</script>

<script>
  // –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ DOM –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
  // (—ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –±—Ä–∞—É–∑–µ—Ä —É–∂–µ –ø–æ—Å—Ç—Ä–æ–∏–ª DOM –≤—ã—à–µ)
</script>

<script>
  // DOM refs –¥–ª—è bet menu (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
  var betSelect = document.getElementById("betSelect");
  var betMenu   = document.getElementById("betMenu");
</script>
</body>
</html>
