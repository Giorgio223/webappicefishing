<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IceFishing Wheel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --leaf1:#e6e8ec;
      --leaf2:#3d647f;

      --red:#e11d48;
      --orange:#fb923c;
      --blue:#0b2a8f;

      --ring1:#0b1220;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 25% 15%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%),
        radial-gradient(1200px 900px at 70% 35%, rgba(255,255,255,.18), rgba(255,255,255,0) 65%),
        url("bg.png") center/cover no-repeat fixed;
    }

    .snow { pointer-events:none; position:fixed; inset:0; z-index:2; overflow:hidden; }
    .snow span{
      position:absolute; top:-10vh;
      width:6px; height:6px;
      background:rgba(255,255,255,.85);
      border-radius:50%;
      opacity:.85;
      animation: fall linear infinite;
    }
    @keyframes fall{ from { transform: translateY(-10vh);} to { transform: translateY(110vh);} }

    .leftHUD{
      position:fixed; left:12px; top:14px;
      display:flex; align-items:center; gap:10px;
      z-index:6; user-select:none; pointer-events:none;
    }
    .cube{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(180,225,255,.75));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      position:relative;
    }
    .cube:after{
      content:""; position:absolute;
      inset:7px 8px 12px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.65); opacity:.9;
    }
    .hudText{
      font-weight:950; letter-spacing:.6px; color:#0b1220; line-height:1;
      min-width:160px; text-transform:uppercase;
      text-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .hudText small{
      display:block; font-weight:900; opacity:.75;
      letter-spacing:.2px; margin-top:3px; font-size:11px;
    }

    .topRight{
      position:fixed; right:12px; top:14px; z-index:6;
      display:flex; align-items:center; gap:10px;
    }
    .tonBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer; user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-decoration:none; color:#0b1220;
      font-weight:950;
    }
    .tonBtn img{ width:22px; height:22px; display:block; border-radius:6px; }
    .tonBtn:active{ transform: translateY(1px); }

    .balancePill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      font-weight:950;
      color:#0b1220;
      min-width:120px;
      justify-content:center;
    }
    .balancePill img{ width:18px; height:18px; border-radius:6px; }
    .balancePill small{ font-weight:900; opacity:.75; margin-left:4px; }

    .wheelWrap{
      position:fixed;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width:min(430px, 92vw);
      height:min(430px, 92vw);
      z-index:3;
      filter: drop-shadow(0 26px 44px rgba(0,0,0,.30));
    }
    canvas{ width:100%; height:100%; border-radius:50%; }

    .pointer{
      position:absolute; top:-8px; left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:30px solid var(--ring1);
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));
      pointer-events:none;
    }

    .bottomUI{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      width:min(430px, 92vw);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:4;
    }

    .historyBar{
      width:100%;
      display:flex; gap:6px;
      justify-content:center; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .chip{
      width:16px; height:16px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      flex:0 0 auto;
      position:relative;
    }
    .chip::after{
      content:"";
      position:absolute; inset:4px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      opacity:.55;
    }
    .chip.fish::before, .chip.leaf::before{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      content:"";
    }
    .chip.fish::before{ content:"üêü"; }
    .chip.leaf::before{ content:"üçÉ"; }

    .bonusPanel{ width:100%; display:flex; flex-direction:column; gap:10px; }
    .bonusTop, .bonusBottom{ display:flex; gap:8px; justify-content:space-between; }

    .btn{
      position:relative;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.55);
      border-radius:16px;
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ height:42px; flex:1 1 0; font-size:13px; }
    .btn.big{
      height:58px; flex:1 1 0; font-size:12px;
      text-transform:uppercase; letter-spacing:.4px;
      text-align:center; padding:0 10px;
    }
    .btnIcon{
      width:26px; height:26px;
      border-radius:999px;
      background: rgba(255,255,255,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      border:1px solid rgba(0,0,0,.10);
    }

    .c-leaf1{ background: color-mix(in srgb, var(--leaf1) 86%, white 14%); color:#0b1220; }
    .c-leaf2{ background: color-mix(in srgb, var(--leaf2) 86%, white 14%); color:#fff; }

    .c-blue { background: color-mix(in srgb, var(--blue) 74%, white 26%); color:#fff; }
    .c-orange{ background: color-mix(in srgb, var(--orange) 74%, white 26%); color:#1b1b1b; }
    .c-red { background: color-mix(in srgb, var(--red) 74%, white 26%); color:#fff; }

    .placedBet{
      position:absolute;
      right:8px;
      top:8px;
      min-width:34px;
      height:28px;
      padding:0 8px;
      border-radius:999px;
      border:2px solid rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:950;
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      background: rgba(255,255,255,.75);
      color:#0b1220;
    }

    .betRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
    }
    .undoBtn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      color:#0b1220;
      -webkit-tap-highlight-color: transparent;
    }
    .undoBtn[disabled]{ opacity:.55; cursor:not-allowed; }

    .betSelect{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.60);
      box-shadow: 0 12px 26px rgba(0,0,0,.16);
      backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .betSelect small{ opacity:.7; font-weight:900; }
    .betMenu{
      position:absolute;
      left:0; right:0;
      bottom:52px;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.80);
      box-shadow: 0 18px 36px rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      display:none;
      z-index:10;
    }
    .betMenu.open{ display:flex; gap:8px; justify-content:space-between; }
    .betChip{
      flex:1 1 0;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.75);
      font-weight:950;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      -webkit-tap-highlight-color: transparent;
    }
    .betChip:active{ transform: translateY(1px); }

    /* Modals */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:20;
    }
    .modalOverlay.open{ display:flex; }
    .sheet{
      width:min(430px, 92vw);
      border-radius:18px 18px 0 0;
      background: rgba(255,255,255,.92);
      box-shadow: 0 -20px 40px rgba(0,0,0,.20);
      border:1px solid rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sheetTitle{
      font-weight:950;
      font-size:16px;
      color:#0b1220;
    }
    .closeBtn{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:950;
      -webkit-tap-highlight-color: transparent;
    }
    .sheetList{ display:flex; flex-direction:column; gap:8px; }
    .sheetAction{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.80);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-weight:950;
      color:#0b1220;
    }
    .sheetAction small{
      opacity:.65;
      font-weight:900;
      font-size:12px;
    }

    .depositInput{
      width:100%;
      height:46px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      padding:0 12px;
      font-size:15px;
      font-weight:900;
      outline:none;
      background: rgba(255,255,255,.85);
      margin:10px 0 12px;
    }
    .row2{
      display:flex;
      gap:10px;
    }
    .row2 .sheetAction{ flex:1 1 0; justify-content:center; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="leftHUD">
    <div class="cube"></div>
    <div class="hudText">
      <div id="hudMain">ICE FISHING</div>
      <small id="hudSub">wheel</small>
    </div>
  </div>

  <div class="topRight">
    <a class="tonBtn" id="tonConnectBtn">
      <img src="ton.png" alt="TON">
      <span id="tonBtnText">TON connect</span>
    </a>
    <div class="balancePill">
      <img src="ton.png" alt="TON">
      <span id="balanceValue">0</span><small>TON</small>
    </div>
  </div>

  <div class="wheelWrap">
    <div class="pointer"></div>
    <canvas id="wheel"></canvas>
  </div>

  <div class="bottomUI">
    <div class="historyBar" id="historyBar"></div>

    <div class="bonusPanel">
      <div class="betRow">
        <div class="betSelect" id="betSelect">
          <span>BET</span>
          <small><span id="betValue">0.2</span> TON</small>
          <div class="betMenu" id="betMenu">
            <div class="betChip" data-bet="0.2">0.2</div>
            <div class="betChip" data-bet="0.5">0.5</div>
            <div class="betChip" data-bet="1">1</div>
            <div class="betChip" data-bet="2">2</div>
          </div>
        </div>
        <button class="undoBtn" id="undoBtn" disabled>‚Ü©</button>
      </div>

      <div class="bonusTop">
        <div class="btn big bettable c-leaf1" data-target="leaf1">
          <div class="btnIcon">üçÉ</div>
          <div>LEAF 1<br><small>+10%</small></div>
        </div>
        <div class="btn big bettable c-leaf2" data-target="leaf2">
          <div class="btnIcon">üçÉ</div>
          <div>LEAF 2<br><small>+20%</small></div>
        </div>
      </div>

      <div class="bonusBottom">
        <div class="btn big bettable c-blue" data-target="blue">
          <div class="btnIcon">üêü</div>
          <div>BLUE FISH<br><small>x2</small></div>
        </div>
        <div class="btn big bettable c-orange" data-target="orange">
          <div class="btnIcon">üêü</div>
          <div>ORANGE FISH<br><small>x3</small></div>
        </div>
        <div class="btn big bettable c-red" data-target="red">
          <div class="btnIcon">üêü</div>
          <div>RED FISH<br><small>x5</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TON MODAL -->
  <div class="modalOverlay" id="tonModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle">TON</div>
        <button class="closeBtn" id="tonClose">‚úï</button>
      </div>

      <div class="sheetList">
        <div class="sheetAction" id="actionBind">
          <span id="walletStatus">Not connected</span>
          <small>Bind wallet</small>
        </div>

        <div class="sheetAction" id="actionDisconnect">
          <span>–û—Ç–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª–µ–∫</span>
          <small>Disconnect</small>
        </div>

        <div class="sheetAction" id="actionDeposit">
          <span>–î–µ–ø–æ–∑–∏—Ç</span>
          <small>Enter amount</small>
        </div>

        <div class="sheetAction" id="actionWithdraw">
          <span>–í—ã–≤–æ–¥</span>
          <small>Later</small>
        </div>
      </div>
    </div>
  </div>

  <!-- DEPOSIT INPUT MODAL -->
  <div class="modalOverlay" id="depositModal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="sheetTitle">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
        <button class="closeBtn" id="depositClose">‚úï</button>
      </div>

      <input id="depositAmount" class="depositInput" type="number" min="0.1" step="0.1" placeholder="–°–∫–æ–ª—å–∫–æ TON –ø–æ–ø–æ–ª–Ω–∏—Ç—å?">

      <div class="row2">
        <div class="sheetAction" id="depositBack">–ù–∞–∑–∞–¥</div>
        <div class="sheetAction" id="depositConfirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</div>
      </div>
    </div>
  </div>

  <!-- TonConnect UI -->
  <script type="module">
    try{
      const mod = await import("https://esm.sh/@tonconnect/ui@2.0.10");
      const { TonConnectUI } = mod;

      const tonUI = new TonConnectUI({
        manifestUrl: `${location.origin}/tonconnect-manifest.json`
      });

      window.__tonUI = tonUI;
      window.__wallet = null;

      tonUI.onStatusChange(wallet => {
        window.__wallet = wallet || null;
        window.dispatchEvent(new Event("wallet_changed"));
      });
    }catch{
      window.__tonUI = null;
      window.__wallet = null;
    }
  </script>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  // snow
  (function initSnow(){
    const box = document.getElementById("snow");
    const flakes = 26;
    for (let i=0;i<flakes;i++){
      const s = document.createElement("span");
      const size = 2 + Math.random()*4;
      s.style.width = size + "px";
      s.style.height = size + "px";
      s.style.left = (Math.random()*100) + "vw";
      s.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
      const dur = 6 + Math.random()*8;
      const delay = Math.random()*-dur;
      s.style.animationDuration = dur + "s";
      s.style.animationDelay = delay + "s";
      box.appendChild(s);
    }
  })();

  function showPopup(title, message){
    tg?.showPopup?.({ title, message, buttons:[{type:"ok"}] });
  }

  // --- TON helpers ---
  // TonConnect –æ–∂–∏–¥–∞–µ—Ç payload –∫–∞–∫ base64 –æ—Ç BOC (Cell).
  // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ base64(—Å—Ç—Ä–æ–∫–∏), –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ—à–µ–ª—å–∫–∏ –≤—ã–¥–∞—é—Ç:
  // ¬´–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é¬ª.
  function bytesToBase64(bytes){
    let bin = "";
    for (const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin);
  }
  let _tonCore = null;
  async function commentToBocBase64(comment){
    if (!_tonCore){
      _tonCore = await import("https://esm.sh/@ton/core@0.58.0");
    }
    const { beginCell } = _tonCore;
    const cell = beginCell().storeUint(0, 32).storeStringTail(String(comment || "")).endCell();
    const boc = cell.toBoc({ idx:false }); // Uint8Array
    return bytesToBase64(boc);
  }

  // TON modal
  const tonModal = document.getElementById("tonModal");
  document.getElementById("tonConnectBtn").addEventListener("click", () => tonModal.classList.add("open"));
  document.getElementById("tonClose").addEventListener("click", () => tonModal.classList.remove("open"));
  tonModal.addEventListener("click", (e) => { if (e.target === tonModal) tonModal.classList.remove("open"); });

  // Deposit modal
  const depositModal = document.getElementById("depositModal");
  document.getElementById("depositClose").addEventListener("click", () => depositModal.classList.remove("open"));
  document.getElementById("depositBack").addEventListener("click", () => depositModal.classList.remove("open"));
  depositModal.addEventListener("click", (e) => { if (e.target === depositModal) depositModal.classList.remove("open"); });

  // Wallet UI
  const balanceValue = document.getElementById("balanceValue");
  const tonBtnText = document.getElementById("tonBtnText");
  const walletStatus = document.getElementById("walletStatus");

  function shortAddr(a){ return a ? (a.slice(0,6) + "..." + a.slice(-6)) : ""; }
  function getWalletAddress(){
    const w = window.__wallet;
    return w?.account?.address || localStorage.getItem("walletAddress") || null;
  }

  function syncWalletUI(){
    const addr = getWalletAddress();
    if (!addr){
      tonBtnText.textContent = "TON connect";
      walletStatus.textContent = "Not connected";
      balanceValue.textContent = "0";
      return;
    }
    localStorage.setItem("walletAddress", addr);
    tonBtnText.textContent = shortAddr(addr);
    walletStatus.textContent = shortAddr(addr);
  }

  async function refreshBalance(){
    const addr = getWalletAddress();
    if (!addr){ balanceValue.textContent = "0"; return; }
    const r = await fetch(`/api/balance?address=${encodeURIComponent(addr)}`, { cache:"no-store" });
    if (!r.ok) return;
    const j = await r.json();
    balanceValue.textContent = String(j.balanceTon ?? 0);
  }

  window.addEventListener("wallet_changed", async () => {
    syncWalletUI();
    await refreshBalance();
  });

  // Bind
  document.getElementById("actionBind").addEventListener("click", async () => {
    if (window.__tonUI?.openModal){
      window.__tonUI.openModal();
      return;
    }
    showPopup("TON", "TonConnect –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å tonconnect-manifest.json");
  });

  // Disconnect
  document.getElementById("actionDisconnect").addEventListener("click", async () => {
    try{
      await window.__tonUI?.disconnect?.();
    }catch{}
    localStorage.removeItem("walletAddress");
    window.__wallet = null;
    syncWalletUI();
    showPopup("TON", "–ö–æ—à–µ–ª—ë–∫ –æ—Ç–≤—è–∑–∞–Ω. –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –¥—Ä—É–≥–æ–π.");
  });

  // Deposit (open input)
  document.getElementById("actionDeposit").addEventListener("click", () => {
    const addr = getWalletAddress();
    if (!addr){ showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }
    depositModal.classList.add("open");
  });

  // Deposit confirm -> send tx -> confirm via server -> credit balance
  document.getElementById("depositConfirm").addEventListener("click", async () => {
    const addr = getWalletAddress();
    if (!addr){ showPopup("TON", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏ –∫–æ—à–µ–ª—ë–∫."); return; }

    const amountTon = Number(document.getElementById("depositAmount").value);
    if (!amountTon || amountTon <= 0){ showPopup("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TON"); return; }
    if (amountTon < 0.1){ showPopup("–û—à–∏–±–∫–∞", "–ú–∏–Ω–∏–º—É–º 0.1 TON"); return; }

    if (!window.__tonUI?.sendTransaction){
      showPopup("TON", "TonConnect UI –Ω–µ –≥–æ—Ç–æ–≤.");
      return;
    }

    // intent
    const r = await fetch("/api/deposit_intent", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ amountTon })
    });
    if (!r.ok){ showPopup("TON", "–°–µ—Ä–≤–µ—Ä –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."); return; }
    const intent = await r.json();

    try{
      await window.__tonUI.sendTransaction({
        validUntil: Math.floor(Date.now()/1000) + 300,
        messages:[{
          address: intent.toAddress,
          amount: intent.amountNano,
          payload: await commentToBocBase64(intent.comment || `ICEFISHING_DEPOSIT:${intent.intentId}`)
        }]
      });

      depositModal.classList.remove("open");
      showPopup("TON", "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—è—é —Å–µ—Ç—å –∏ –∑–∞—á–∏—Å–ª—è—é...");

      // poll confirm
      await waitAndCredit(intent.intentId, addr);
    }catch(e){
      showPopup("TON", "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∫–æ—à–µ–ª—å–∫–∞.");
    }
  });

  async function waitAndCredit(intentId, address){
    for (let i=0;i<12;i++){
      const r = await fetch("/api/confirm_deposit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ intentId, address })
      });
      if (r.ok){
        const j = await r.json();
        if (j.status === "credited"){
          await refreshBalance();
          showPopup("TON", `–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω: +${j.creditedTon} TON`);
          return;
        }
      }
      await new Promise(res => setTimeout(res, 2000));
    }
    showPopup("TON", "–ü–æ–∫–∞ –Ω–µ –≤–∏–∂—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–µ—Ç–∏. –ü–æ–¥–æ–∂–¥–∏ –º–∏–Ω—É—Ç—É –∏ –æ—Ç–∫—Ä–æ–π –¥–µ–ø–æ–∑–∏—Ç –µ—â—ë —Ä–∞–∑.");
  }

  document.getElementById("actionWithdraw").addEventListener("click", () => {
    showPopup("TON", "–í—ã–≤–æ–¥ –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º.");
  });

  // --- BETS + UNDO
  let currentBet = 0.2;
  const betSelect = document.getElementById("betSelect");
  const betMenu = document.getElementById("betMenu");
  const betValue = document.getElementById("betValue");
  const undoBtn = document.getElementById("undoBtn");

  const totals = new Map();
  const actions = [];
  function fmt(x){
    const s = (Math.round(x*10)/10).toFixed(1);
    return s.endsWith(".0") ? s.slice(0,-2) : s;
  }
  function updateUndoState(){ undoBtn.disabled = actions.length === 0; }
  function closeBetMenu(){ betMenu.classList.remove("open"); }
  function toggleBetMenu(){ betMenu.classList.toggle("open"); }

  betSelect.addEventListener("click", (e) => { e.stopPropagation(); toggleBetMenu(); });
  betMenu.querySelectorAll(".betChip").forEach(chip => {
    chip.addEventListener("click", (e) => {
      e.stopPropagation();
      currentBet = Number(chip.dataset.bet);
      betValue.textContent = fmt(currentBet);
      closeBetMenu();
    });
  });
  document.addEventListener("click", () => closeBetMenu());

  function renderTotalOnButton(target){
    const btn = document.querySelector(`.bettable[data-target="${target}"]`);
    if (!btn) return;
    const total = totals.get(target) || 0;
    const old = btn.querySelector(".placedBet");
    if (old) old.remove();
    if (total > 0){
      const badge = document.createElement("div");
      badge.className = "placedBet";
      badge.textContent = fmt(total);
      btn.appendChild(badge);
    }
  }
  function addBet(target, amount){
    const prev = totals.get(target) || 0;
    const next = Math.round((prev + amount) * 10) / 10;
    totals.set(target, next);
    actions.push({ target, amount });
    renderTotalOnButton(target);
    updateUndoState();
  }
  function undoLast(){
    if (actions.length === 0) return;
    const last = actions.pop();
    const prev = totals.get(last.target) || 0;
    const next = Math.round((prev - last.amount) * 10) / 10;
    if (next <= 0) totals.delete(last.target);
    else totals.set(last.target, next);
    renderTotalOnButton(last.target);
    updateUndoState();
  }
  undoBtn.addEventListener("click", (e) => { e.stopPropagation(); undoLast(); });

  document.querySelectorAll(".bettable").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      addBet(btn.dataset.target, currentBet);
    });
  });

  // --- WHEEL DRAW
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const N = 53;
  const sectors = [];
  for (let i=0;i<N;i++){
    const isFish = i % 2 === 0;
    sectors.push({
      icon: isFish ? "fish" : "leaf",
      fill: isFish ? (i%6===0? "rgba(225,29,72,0.95)" : i%6===2? "rgba(251,146,60,0.95)" : "rgba(11,42,143,0.95)") : (i%4===1? "#e6e8ec" : "#3d647f")
    });
  }

  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  let angle = 0;
  let spinning = false;

  const startOffset = -Math.PI/2;
  const step = (Math.PI*2)/N;

  function normalize(a){
    while (a < 0) a += Math.PI*2;
    while (a >= Math.PI*2) a -= Math.PI*2;
    return a;
  }

  function indexAtPointer(ang){
    const pointerWorld = -Math.PI/2;
    const rel = normalize(pointerWorld - ang - startOffset);
    const idx = Math.floor(rel / step);
    return Math.max(0, Math.min(N-1, idx));
  }

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

  function drawFishIcon(x,y,scale,stroke){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);
    ctx.lineWidth = 3;
    ctx.strokeStyle = stroke;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.beginPath();
    ctx.ellipse(0,0,18,12,0,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(18,0);
    ctx.lineTo(30,10);
    ctx.lineTo(30,-10);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = stroke;
    ctx.beginPath();
    ctx.arc(-6,-3,2.2,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawLeafIcon(x,y,scale,stroke){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(scale,scale);
    ctx.lineWidth = 3;
    ctx.strokeStyle = stroke;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.beginPath();
    ctx.ellipse(0,0,16,24,Math.PI/6,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0,-22);
    ctx.lineTo(0,22);
    ctx.stroke();
    ctx.restore();
  }

  function drawWheel(activeIndex){
    const w = canvas.width / devicePixelRatio;
    const h = canvas.height / devicePixelRatio;
    const cx = w/2, cy = h/2;
    const R = Math.min(w,h)/2 - 6;
    const innerR = R*0.52;

    ctx.clearRect(0,0,w,h);

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);

    for (let i=0;i<N;i++){
      const a0 = startOffset + i*step;
      const a1 = a0 + step;

      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,R,a0,a1,false);
      ctx.closePath();
      ctx.fillStyle = sectors[i].fill;
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 1;
      ctx.stroke();

      const mid = (a0+a1)/2;
      const x = Math.cos(mid) * (R*0.72);
      const y = Math.sin(mid) * (R*0.72);

      const stroke = "rgba(0,0,0,0.35)";
      if (sectors[i].icon === "fish"){
        drawFishIcon(x,y,0.9,stroke);
      }else{
        drawLeafIcon(x,y,0.9,stroke);
      }
    }

    ctx.restore();

    if (spinning){
      ctx.save();
      ctx.translate(cx,cy);

      ctx.beginPath();
      ctx.arc(0,0, innerR*1.55, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.08)";
      ctx.lineWidth = 10;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(0,0, innerR*1.05, 0, Math.PI*2);
      ctx.fillStyle = "rgba(240,250,255,0.96)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.lineWidth = 6;
      ctx.stroke();

      ctx.fillStyle = "rgba(11,18,32,0.90)";
      ctx.font = `950 ${Math.floor(innerR*0.38)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ICE", 0, -innerR*0.18);
      ctx.fillText("FISHING", 0, innerR*0.20);

      ctx.restore();
    }
  }

  const TWO_PI = Math.PI * 2;
  const SPIN_TURNS = 10;
  const SPIN_MS = 2600;

  function getDesiredModForWinner(winnerIdx){
    const pointerWorld = -Math.PI/2;
    const winnerCenter = (winnerIdx + 0.5)*step + startOffset;
    return normalize(pointerWorld - winnerCenter);
  }
  function buildStrongTarget(winnerIdx){
    const desiredMod = getDesiredModForWinner(winnerIdx);
    const base = angle - SPIN_TURNS * TWO_PI;
    const k = Math.floor((base - desiredMod) / TWO_PI);
    return desiredMod + k * TWO_PI;
  }

  const hudMain = document.getElementById("hudMain");
  const hudSub  = document.getElementById("hudSub");
  function setHUDSpinning(){
    hudMain.textContent = "ICE FISHING";
    hudSub.textContent = "spinning";
  }

  // history UI
  const historyBar = document.getElementById("historyBar");
  const history = [];
  const HISTORY_MAX = 18;

  function renderHistory(){
    historyBar.innerHTML = "";
    for (const idx of history){
      const sec = sectors[idx];
      const el = document.createElement("div");
      el.className = "chip " + (sec.icon === "fish" ? "fish" : "leaf");
      el.style.background = sec.fill;
      historyBar.appendChild(el);
    }
  }

  // LIVE SYNC
  let timeOffset = 0;
  let scheduledForRoundId = null;
  let scheduledSpinTimer = null;

  // –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ roundId-1
  let lastServerHistoryRoundId = null;

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: –Ω–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å ¬´pendingWinner¬ª –≥–ª–æ–±–∞–ª—å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
  // –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –∏ pending –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç—Å—è ‚Äî –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏—é
  // ¬´—É—Ç–µ–∫–∞–µ—Ç¬ª —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
  // –ü–æ—ç—Ç–æ–º—É winner/roundId –ø–µ—Ä–µ–¥–∞—ë–º –ø—Ä—è–º–æ –≤ spinToWinner() –∏ –∏–º–µ–Ω–Ω–æ –∏—Ö –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é.
  let lastCommittedRoundId = null;

  function serverTimeNow(){ return Date.now() + timeOffset; }

  async function fetchState(){
    const r = await fetch("/api/state", { cache:"no-store" });
    if (!r.ok) throw new Error("api_state_error");
    return await r.json();
  }

  function setHUDCountdown(endAt){
    if (spinning) return;
    const leftMs = endAt - serverTimeNow();
    const sec = Math.max(0, Math.ceil(leftMs / 1000));
    hudMain.textContent = String(sec);
    hudSub.textContent = "–¥–æ —Å–ø–∏–Ω–∞";
  }

  function applyServerHistory(state){
    const list = (state.history || []).slice().sort((a,b)=>a.roundId-b.roundId);
    history.length = 0;
    for (const item of list.slice(-HISTORY_MAX)) history.push(item.winnerIndex);
    renderHistory();
    lastServerHistoryRoundId = list.length ? list[list.length-1].roundId : null;
  }

  function scheduleSpinAtEnd(endAt, winnerIndex, roundId){
    if (scheduledSpinTimer) clearTimeout(scheduledSpinTimer);

    const delay = Math.max(0, endAt - serverTimeNow());
    scheduledSpinTimer = setTimeout(() => { spinToWinner(winnerIndex, roundId); }, delay);

    scheduledForRoundId = roundId;
  }

  async function spinToWinner(winnerIndex, roundId){
    if (spinning) return;
    spinning = true;
    setHUDSpinning();

    const target = buildStrongTarget(winnerIndex);
    const start = angle;
    const end = target;
    const t0 = performance.now();

    await new Promise(resolve=>{
      function frame(now){
        const t = Math.min(1, (now - t0) / SPIN_MS);
        const k = easeOutCubic(t);
        angle = start + (end - start) * k;
        drawWheel(indexAtPointer(angle));
        if (t < 1) requestAnimationFrame(frame);
        else resolve();
      }
      requestAnimationFrame(frame);
    });

    spinning = false;
    drawWheel(null);

    // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ò –¢–û–õ–¨–ö–û –≠–¢–û–¢ roundId
    // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –ø—Ä–∏—Å–ª–∞–ª —ç—Ç–æ—Ç —Ä–∞—É–Ω–¥ (–∏–ª–∏ –µ—Å–ª–∏ –º—ã —É–∂–µ –¥–æ–±–∞–≤–ª—è–ª–∏).
    const alreadyOnServer = (lastServerHistoryRoundId !== null && roundId <= lastServerHistoryRoundId);
    const alreadyLocally = (lastCommittedRoundId !== null && roundId <= lastCommittedRoundId);
    if (!alreadyOnServer && !alreadyLocally) {
      history.push(winnerIndex);
      if (history.length > HISTORY_MAX) history.splice(0, history.length - HISTORY_MAX);
      renderHistory();
      lastCommittedRoundId = roundId;
    }
  }

  async function syncLoop(){
    try{
      const state = await fetchState();
      timeOffset = state.serverNow - Date.now();

      // —Å–µ—Ä–≤–µ—Ä–Ω—ã–π lastCompleted roundId
      const serverLast = (state.history && state.history.length)
        ? Math.max(...state.history.map(x => x.roundId))
        : null;

      // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º (—ç—Ç–æ —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç)
      if (serverLast !== null && serverLast !== lastServerHistoryRoundId) {
        applyServerHistory(state);
      }

      setHUDCountdown(state.round.endAt);

      // –ø–ª–∞–Ω–∏—Ä—É–µ–º —Å–ø–∏–Ω —Å—Ç—Ä–æ–≥–æ –Ω–∞ endAt
      if (scheduledForRoundId !== state.round.roundId){
        scheduleSpinAtEnd(state.round.endAt, state.round.winnerIndex, state.round.roundId);
      }
    }catch{}
  }

  // init
  updateUndoState();
  syncWalletUI();
  refreshBalance();
  drawWheel(null);
  renderHistory();
  syncLoop();
  setInterval(syncLoop, 500);
  setInterval(refreshBalance, 5000);
</script>
</body>
</html>
